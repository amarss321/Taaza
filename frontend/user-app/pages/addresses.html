<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>My Addresses</title>
    <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;700;900&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <!-- Google Maps API with Places -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCTBpRefq3kQWU79YiRZOeGb7jamVPHHnw&libraries=places"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        :root {
            --golden-yellow: #FFD700;
            --dark-blue: #0C2D57;
        }

        /* Smooth transitions */
        .transition-slow {
            transition: all 0.3s ease;
        }
        
        /* Map container */
        #map-container, #google-map {
            height: 300px;
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-top: 1rem;
        }
        
        /* Toast notification */
        #toast {
            transition: opacity 0.3s ease;
        }
        
        /* Loading spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Autocomplete dropdown styling */
        .pac-container {
            z-index: 10000 !important;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: none;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "primary": "#0C2D57",
                        "background-light": "#f6f7f8",
                        "content-light": "#ffffff",
                        "text-light": "#111827",
                        "subtext-light": "#64748b",
                        "danger": "#ef4444"
                    },
                    fontFamily: {
                        "display": ["Work Sans", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.5rem",
                        "lg": "0.75rem",
                        "xl": "1rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            min-height: max(884px, 100dvh);
            background-color: #f6f7f8;
        }

        /* Custom styles with your colors */
        .golden-bg {
            background-color: #FFD700;
        }

        .dark-blue-text {
            color: #0C2D57;
        }

        .dark-blue-bg {
            background-color: #0C2D57;
        }
    </style>
</head>

<body class="font-display">
    <div class="relative flex min-h-screen w-full flex-col max-w-screen-2xl mx-auto">
        <!-- Address Modal -->
        <div id="address-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden">
            <div class="bg-white rounded-xl shadow-lg w-full max-w-md mx-4 p-6 relative max-h-[90vh] overflow-y-auto">
                <button type="button" onclick="closeModal()"
                    class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100">
                    <span class="material-symbols-outlined">close</span>
                </button>
                <h2 id="modal-title" class="text-xl font-bold mb-4">Add Address</h2>
                <form id="address-form" class="space-y-4">
                    <input type="hidden" id="edit-index" />
                    <div>
                        <label class="block text-sm font-medium mb-1" for="address-label">Label</label>
                        <input id="address-label" class="w-full rounded-lg border p-2" type="text"
                            placeholder="e.g. Home, Work" required />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" for="address-line">Address</label>
                        <input id="address-line" class="w-full rounded-lg border p-2" type="text"
                            placeholder="Street, Apt, etc." required />
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" for="address-city">City</label>
                            <input id="address-city" class="w-full rounded-lg border p-2" type="text" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" for="address-zip">ZIP Code</label>
                            <input id="address-zip" class="w-full rounded-lg border p-2" type="text" required />
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1" for="address-country">Country</label>
                        <input id="address-country" class="w-full rounded-lg border p-2" type="text" required />
                    </div>

                    <!-- Map Location Selection -->
                    <div>
                        <label class="block text-sm font-medium mb-1">Location on Map</label>
                        <button type="button" onclick="openMapModal()"
                            class="flex items-center gap-2 text-primary mb-2">
                            <span class="material-symbols-outlined">map</span>
                            <span>Select on Map</span>
                        </button>
                        <div class="text-xs text-subtext-light">
                            <span id="coordinates-display">No location selected</span>
                        </div>
                        <input type="hidden" id="address-lat" />
                        <input type="hidden" id="address-lng" />
                    </div>

                    <div class="flex items-center gap-2">
                        <input id="address-default" type="checkbox" class="rounded" />
                        <label for="address-default" class="text-sm">Set as default address</label>
                    </div>
                    <button type="submit"
                        class="w-full golden-bg dark-blue-text font-bold rounded-lg py-3 mt-2 hover:bg-[#e6c200]">Save
                        Address</button>
                </form>
            </div>
        </div>

        <!-- Map Modal -->
        <div id="map-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden">
            <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl mx-4 p-6 relative">
                <button type="button" onclick="closeMapModal()"
                    class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 z-10">
                    <span class="material-symbols-outlined">close</span>
                </button>
                <h2 class="text-xl font-bold mb-4">Select Location on Map</h2>
                <div class="flex gap-2 mb-4">
                    <button id="locate-btn" onclick="locateUser()"
                        class="flex items-center gap-1 text-sm bg-primary/10 text-primary px-3 py-2 rounded-lg hover:bg-primary/20 transition-colors">
                        <span class="material-symbols-outlined">my_location</span>
                        Use My Location
                    </button>
                    <button onclick="showLocationHelp()" 
                        class="flex items-center gap-1 text-sm bg-gray-100 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-200 transition-colors">
                        <span class="material-symbols-outlined">help</span>
                        Help
                    </button>
                    <div id="locate-loading"
                        class="hidden items-center gap-1 text-sm bg-primary/10 text-primary px-3 py-2 rounded-lg">
                        <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
                        <span>Getting location...</span>
                    </div>
                </div>
                <div id="google-map"></div>
                <div class="flex justify-end gap-2 mt-4">
                    <button type="button" onclick="closeMapModal()"
                        class="px-4 py-2 rounded-lg border hover:bg-gray-100">
                        Cancel
                    </button>
                    <button type="button" onclick="confirmLocation()"
                        class="px-4 py-2 rounded-lg golden-bg dark-blue-text font-bold hover:bg-[#e6c200]">
                        Confirm Location
                    </button>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header class="dark-blue-bg text-white sticky top-0 z-10 shadow-md">
            <div class="px-3 sm:px-6 lg:px-12 xl:px-16">
                <div class="flex h-16 sm:h-20 lg:h-24 items-center justify-between">
                    <button class="p-2 -ml-2" onclick="history.back()" aria-label="Go back">
                        <svg fill="currentColor" height="24" viewBox="0 0 256 256" width="24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z">
                            </path>
                        </svg>
                    </button>
                    <h1 class="text-lg sm:text-xl lg:text-2xl xl:text-3xl font-bold">My Addresses</h1>
                    <div class="w-10 h-10 flex-shrink-0"></div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow">
            <div id="addresses-list" class="px-3 sm:px-6 lg:px-12 xl:px-16 pt-6 pb-8 space-y-4"></div>
            <div id="empty-state" class="hidden flex flex-col items-center justify-center py-16">
                <span class="material-symbols-outlined text-6xl text-primary mb-4">location_off</span>
                <p class="text-lg text-subtext-light mb-2">No addresses found</p>
                <p class="text-subtext-light mb-6">Add your first address to get started.</p>
                <button onclick="openModal()"
                    class="golden-bg dark-blue-text font-bold rounded-lg px-6 py-3 hover:bg-[#e6c200]">Add
                    Address</button>
            </div>
        </main>

        <!-- Add New Address Button -->
        <div class="p-3 sm:p-6 lg:p-12 xl:p-16 sticky bottom-0 bg-background-light">
            <button onclick="openModal()" class="flex w-full items-center justify-center gap-2 rounded-lg 
                 h-12 sm:h-14 lg:h-16  
                 px-6 lg:px-8  
                 golden-bg dark-blue-text font-bold hover:bg-[#e6c200] active:bg-[#ccad00] 
                 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/50">
                <span class="material-symbols-outlined">add</span>
                <span class="truncate">Add New Address</span>
            </button>
        </div>

        <div class="h-5"></div>
    </div>

    <script src="../js/session.js"></script>
    <script src="../js/addresses-api.js"></script>
    <script>
        // Address management logic
        let addresses = [];
        let addressAPI = new AddressAPI();

        // Google Maps variables
        let map, marker, selectedLocation = null;
        let autocomplete;

        function renderAddresses() {
            const list = document.getElementById('addresses-list');
            const empty = document.getElementById('empty-state');
            list.innerHTML = '';
            if (!addresses.length) {
                list.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }
            list.classList.remove('hidden');
            empty.classList.add('hidden');
            addresses.forEach((addr, i) => {
                const card = document.createElement('div');
                card.className = 'bg-content-light rounded-lg shadow-sm overflow-hidden mb-4';
                card.innerHTML = `
                    <div class="p-4 sm:p-6 flex items-start justify-between">
                        <div class="space-y-2 flex-1">
                            <div class="flex items-center gap-3">
                                <div class="flex h-10 w-10 items-center justify-center rounded-full bg-primary/10 text-primary">
                                    <span class="material-symbols-outlined">${addr.label.toLowerCase() === 'work' ? 'work' : 'home'}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <h2 class="text-lg sm:text-xl font-bold text-text-light">${addr.label}</h2>
                                    ${addr.is_default ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-medium">Default</span>' : ''}
                                </div>
                            </div>
                            <div class="pl-13">
                                <p class="text-text-light">${addr.address_line}</p>
                                <p class="text-subtext-light">${addr.city}, ${addr.zip_code}</p>
                                <p class="text-subtext-light">${addr.country}</p>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 items-end">
                            ${!addr.is_default ? `<button onclick="setDefaultAddress(${addr.id})" class="text-xs bg-primary/10 text-primary px-3 py-1 rounded-full hover:bg-primary/20 transition-slow">Set Default</button>` : ''}
                            <button onclick="editAddress(${addr.id})" class="p-2 rounded-full hover:bg-primary/5 transition-slow">
                                <span class="material-symbols-outlined text-primary">edit</span>
                            </button>
                            <button onclick="deleteAddress(${addr.id})" class="p-2 rounded-full hover:bg-danger/5 transition-slow">
                                <span class="material-symbols-outlined text-danger">delete</span>
                            </button>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function openModal(editAddr) {
            document.getElementById('address-modal').classList.remove('hidden');
            document.getElementById('address-form').reset();
            document.getElementById('edit-index').value = '';
            document.getElementById('coordinates-display').textContent = 'No location selected';
            document.getElementById('address-lat').value = '';
            document.getElementById('address-lng').value = '';
            selectedLocation = null;
            document.getElementById('modal-title').textContent = editAddr ? 'Edit Address' : 'Add Address';

            // Initialize autocomplete for address input
            initAutocomplete();

            if (editAddr) {
                document.getElementById('address-label').value = editAddr.label || '';
                document.getElementById('address-line').value = editAddr.address_line || '';
                document.getElementById('address-city').value = editAddr.city || '';
                document.getElementById('address-zip').value = editAddr.zip_code || '';
                document.getElementById('address-country').value = editAddr.country || '';
                document.getElementById('address-default').checked = editAddr.is_default || false;
                document.getElementById('edit-index').value = editAddr.id;

                if (editAddr.latitude && editAddr.longitude) {
                    document.getElementById('address-lat').value = editAddr.latitude;
                    document.getElementById('address-lng').value = editAddr.longitude;
                    document.getElementById('coordinates-display').textContent =
                        `${parseFloat(editAddr.latitude).toFixed(4)}, ${parseFloat(editAddr.longitude).toFixed(4)}`;
                    selectedLocation = { lat: parseFloat(editAddr.latitude), lng: parseFloat(editAddr.longitude) };
                }
            }
        }

        function closeModal() {
            document.getElementById('address-modal').classList.add('hidden');
        }

        function openMapModal() {
            document.getElementById('map-modal').classList.remove('hidden');
            initMap();
        }

        function closeMapModal() {
            document.getElementById('map-modal').classList.add('hidden');
            if (map) {
                // Google Maps doesn't need explicit cleanup like Leaflet
                map = null;
                marker = null;
            }
        }

        function initAutocomplete() {
            const addressInput = document.getElementById('address-line');

            // Remove any existing autocomplete bindings
            if (autocomplete) {
                google.maps.event.clearInstanceListeners(addressInput);
            }

            // Create the autocomplete object
            autocomplete = new google.maps.places.Autocomplete(addressInput, {
                types: ['address'],
                componentRestrictions: { country: '' } // Remove this line to allow all countries
            });

            // When the user selects an address from the dropdown, populate the form fields
            autocomplete.addListener('place_changed', function () {
                const place = autocomplete.getPlace();
                if (!place.geometry) {
                    // User entered the name of a Place that was not suggested and pressed Enter
                    return;
                }

                // Extract address components
                let streetNumber = '';
                let route = '';
                let city = '';
                let state = '';
                let zipCode = '';
                let country = '';

                for (const component of place.address_components) {
                    const componentType = component.types[0];

                    switch (componentType) {
                        case 'street_number':
                            streetNumber = component.long_name;
                            break;
                        case 'route':
                            route = component.long_name;
                            break;
                        case 'locality':
                            city = component.long_name;
                            break;
                        case 'administrative_area_level_1':
                            state = component.long_name;
                            break;
                        case 'postal_code':
                            zipCode = component.long_name;
                            break;
                        case 'country':
                            country = component.long_name;
                            break;
                    }
                }

                // Set the address line
                let addressLine = '';
                if (streetNumber && route) {
                    addressLine = `${streetNumber} ${route}`;
                } else if (route) {
                    addressLine = route;
                } else {
                    addressLine = place.formatted_address.split(',')[0];
                }

                document.getElementById('address-line').value = addressLine;

                // Set city
                if (city) {
                    document.getElementById('address-city').value = city;
                }

                // Set ZIP code
                if (zipCode) {
                    document.getElementById('address-zip').value = zipCode;
                }

                // Set country
                if (country) {
                    document.getElementById('address-country').value = country;
                }

                // Set coordinates
                const lat = place.geometry.location.lat();
                const lng = place.geometry.location.lng();

                document.getElementById('address-lat').value = lat;
                document.getElementById('address-lng').value = lng;
                document.getElementById('coordinates-display').textContent =
                    `${lat.toFixed(4)}, ${lng.toFixed(4)}`;

                selectedLocation = { lat, lng };

                // If no label is set, suggest one
                if (!document.getElementById('address-label').value) {
                    if (place.name && place.name !== addressLine) {
                        document.getElementById('address-label').value = place.name;
                    } else if (place.types.includes('establishment')) {
                        document.getElementById('address-label').value = 'My Location';
                    }
                }
            });
        }

        function initMap() {
            console.log('🗺️ Initializing Google Map...');
            
            // Default center (London)
            const defaultCenter = { lat: 51.505, lng: -0.09 };

            // Create the map
            map = new google.maps.Map(document.getElementById('google-map'), {
                zoom: 13,
                center: selectedLocation || defaultCenter,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                zoomControl: true,
                gestureHandling: 'cooperative'
            });

            console.log('✅ Google Map initialized');

            // If we have a previously selected location, add a marker
            if (selectedLocation) {
                console.log('📍 Setting existing location marker');
                setMarker(selectedLocation);
            }

            // Add click event to set marker
            map.addListener('click', function (event) {
                console.log('👆 Map clicked at:', event.latLng.lat(), event.latLng.lng());
                setMarker(event.latLng);
                reverseGeocode(event.latLng.lat(), event.latLng.lng());
            });
            
            // Add instruction overlay
            const instructionDiv = document.createElement('div');
            instructionDiv.innerHTML = '👆 Click on map to select location or use "My Location" button';
            instructionDiv.style.cssText = 'background: rgba(0,0,0,0.7); color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; position: absolute; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; pointer-events: none;';
            document.getElementById('google-map').appendChild(instructionDiv);
            
            // Hide instruction after 5 seconds
            setTimeout(() => {
                if (instructionDiv.parentNode) {
                    instructionDiv.remove();
                }
            }, 5000);
        }

        function setMarker(location) {
            // Remove existing marker
            if (marker) {
                marker.setMap(null);
            }

            // Create new marker
            marker = new google.maps.Marker({
                position: location,
                map: map,
                draggable: true
            });

            // Update selected location when marker is dragged
            marker.addListener('dragend', function () {
                const position = marker.getPosition();
                selectedLocation = { lat: position.lat(), lng: position.lng() };
                reverseGeocode(position.lat(), position.lng());
            });

            selectedLocation = { lat: location.lat(), lng: location.lng() };
        }

        function locateUser() {
            console.log('🌍 Geolocation attempt started');
            console.log('🔒 Protocol:', window.location.protocol);
            console.log('🌐 Host:', window.location.host);
            
            // Check if geolocation is supported
            if (!navigator.geolocation) {
                showToast('❌ Geolocation not supported by your browser');
                return;
            }

            // Check if we're on HTTPS or localhost
            const isSecure = window.location.protocol === 'https:' || 
                           window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1';
            
            if (!isSecure) {
                showToast('⚠️ Location requires HTTPS. Try accessing via HTTPS.');
                console.warn('Geolocation requires HTTPS in production');
            }

            // Show loading state
            document.getElementById('locate-btn').classList.add('hidden');
            document.getElementById('locate-loading').classList.remove('hidden');
            
            // Extended timeout for better reliability
            const forceTimeout = setTimeout(() => {
                document.getElementById('locate-btn').classList.remove('hidden');
                document.getElementById('locate-loading').classList.add('hidden');
                showToast('⏱️ Location request timed out. Check permissions and try again.');
                console.log('🚫 Forced timeout after 15 seconds');
            }, 15000);

            // Try to get location with better options
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    clearTimeout(forceTimeout);
                    console.log('✅ Location success:', position);
                    console.log('📍 Coordinates:', position.coords.latitude, position.coords.longitude);
                    console.log('🎯 Accuracy:', position.coords.accuracy, 'meters');
                    
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Update map
                    if (map) {
                        map.setCenter(userLocation);
                        map.setZoom(16);
                        setMarker(userLocation);
                        reverseGeocode(userLocation.lat, userLocation.lng);
                    }
                    
                    showToast('📍 Location found successfully!');

                    // Hide loading state
                    document.getElementById('locate-btn').classList.remove('hidden');
                    document.getElementById('locate-loading').classList.add('hidden');
                },
                function(error) {
                    clearTimeout(forceTimeout);
                    console.error('❌ Geolocation error:', error);
                    console.log('🔢 Error code:', error.code);
                    console.log('💬 Error message:', error.message);
                    
                    // Hide loading state
                    document.getElementById('locate-btn').classList.remove('hidden');
                    document.getElementById('locate-loading').classList.add('hidden');

                    let errorMsg = '❌ Unable to get your location';
                    let instructions = '';
                    
                    switch (error.code) {
                        case 1: // PERMISSION_DENIED
                            errorMsg = '🚫 Location access denied';
                            instructions = 'Click the 🔒 icon in your address bar and allow location access, then try again.';
                            console.log('🚫 User denied location permission');
                            break;
                        case 2: // POSITION_UNAVAILABLE
                            errorMsg = '📡 Location unavailable';
                            instructions = 'Check your GPS/WiFi connection and try again.';
                            console.log('📡 Position unavailable - GPS/network issue');
                            break;
                        case 3: // TIMEOUT
                            errorMsg = '⏱️ Location request timed out';
                            instructions = 'Please try again. Make sure GPS is enabled.';
                            console.log('⏱️ Geolocation timeout');
                            break;
                        default:
                            errorMsg = `❌ Location error (${error.code})`;
                            instructions = error.message;
                            console.log('❓ Unknown geolocation error:', error);
                    }
                    
                    showToast(errorMsg);
                    
                    // Show detailed instructions after a delay
                    setTimeout(() => {
                        if (instructions) {
                            showToast(instructions);
                        }
                    }, 2500);
                },
                {
                    enableHighAccuracy: true,    // Use GPS for better accuracy
                    timeout: 10000,             // 10 second timeout
                    maximumAge: 60000           // 1 minute cache
                }
            );
        }

        function reverseGeocode(lat, lng) {
            const geocoder = new google.maps.Geocoder();
            const latLng = { lat: lat, lng: lng };

            geocoder.geocode({ 'location': latLng }, function (results, status) {
                if (status === 'OK') {
                    if (results[0]) {
                        const address = results[0];

                        // Extract address components
                        let streetNumber = '';
                        let route = '';
                        let city = '';
                        let zipCode = '';
                        let country = '';

                        for (const component of address.address_components) {
                            const componentType = component.types[0];

                            switch (componentType) {
                                case 'street_number':
                                    streetNumber = component.long_name;
                                    break;
                                case 'route':
                                    route = component.long_name;
                                    break;
                                case 'locality':
                                    city = component.long_name;
                                    break;
                                case 'postal_code':
                                    zipCode = component.long_name;
                                    break;
                                case 'country':
                                    country = component.long_name;
                                    break;
                            }
                        }

                        // Set the address line
                        let addressLine = '';
                        if (streetNumber && route) {
                            addressLine = `${streetNumber} ${route}`;
                        } else if (route) {
                            addressLine = route;
                        } else {
                            // Fallback to formatted address
                            addressLine = address.formatted_address.split(',')[0];
                        }

                        document.getElementById('address-line').value = addressLine;

                        // Set city
                        if (city) {
                            document.getElementById('address-city').value = city;
                        }

                        // Set ZIP code
                        if (zipCode) {
                            document.getElementById('address-zip').value = zipCode;
                        }

                        // Set country
                        if (country) {
                            document.getElementById('address-country').value = country;
                        }

                        // Suggest a label if none is set
                        if (!document.getElementById('address-label').value) {
                            document.getElementById('address-label').value = 'My Location';
                        }
                    }
                } else {
                    console.error('Geocoder failed due to: ' + status);
                }
            });
        }

        function confirmLocation() {
            console.log('📍 Confirming location:', selectedLocation);
            
            if (selectedLocation) {
                const lat = selectedLocation.lat;
                const lng = selectedLocation.lng;
                
                // Ensure coordinates are valid numbers
                if (typeof lat === 'number' && typeof lng === 'number' && !isNaN(lat) && !isNaN(lng)) {
                    document.getElementById('address-lat').value = lat;
                    document.getElementById('address-lng').value = lng;
                    document.getElementById('coordinates-display').textContent =
                        `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    
                    console.log('✅ Location confirmed:', lat, lng);
                    showToast('📍 Location selected successfully!');
                } else {
                    console.error('❌ Invalid location data:', selectedLocation);
                    showToast('❌ Invalid location data. Please try again.');
                    return;
                }
            } else {
                console.warn('⚠️ No location selected');
                showToast('⚠️ Please select a location on the map first.');
                return;
            }
            
            closeMapModal();
        }

        document.getElementById('address-form').onsubmit = async function (e) {
            e.preventDefault();
            console.log('📝 Form submission started...');
            
            // Get form values
            const label = document.getElementById('address-label').value.trim();
            const addressLine = document.getElementById('address-line').value.trim();
            const city = document.getElementById('address-city').value.trim();
            const zipCode = document.getElementById('address-zip').value.trim();
            const country = document.getElementById('address-country').value.trim();
            const lat = document.getElementById('address-lat').value;
            const lng = document.getElementById('address-lng').value;
            const isDefault = document.getElementById('address-default').checked;
            const editId = document.getElementById('edit-index').value;
            
            console.log('📋 Form data:', {
                label, addressLine, city, zipCode, country, lat, lng, isDefault, editId
            });
            
            // Validate required fields
            if (!label || !addressLine || !city || !zipCode || !country) {
                showToast('❌ Please fill in all required fields');
                return;
            }
            
            // Convert coordinates to proper format
            let latitude = null;
            let longitude = null;
            
            if (lat && lng) {
                latitude = parseFloat(lat);
                longitude = parseFloat(lng);
                
                // Validate coordinates
                if (isNaN(latitude) || isNaN(longitude)) {
                    console.warn('⚠️ Invalid coordinates:', lat, lng);
                    latitude = null;
                    longitude = null;
                } else {
                    console.log('📍 Valid coordinates:', latitude, longitude);
                }
            }
            
            const addressData = {
                label,
                address_line: addressLine,
                city,
                zip_code: zipCode,
                country,
                latitude,
                longitude,
                is_default: isDefault
            };
            
            console.log('🚀 Sending address data:', addressData);
            
            try {
                let result;
                if (editId) {
                    console.log('✏️ Updating address ID:', editId);
                    result = await addressAPI.updateAddress(editId, addressData);
                } else {
                    console.log('➕ Creating new address');
                    result = await addressAPI.createAddress(addressData);
                }
                
                console.log('✅ Address saved successfully:', result);
                closeModal();
                loadAddresses();
                showToast('✅ Address saved successfully!');
                
            } catch (error) {
                console.error('❌ Save error:', error);
                console.log('🔍 Error details:', {
                    message: error.message,
                    stack: error.stack
                });
                
                if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    showToast('🔒 Session expired. Please login again.');
                    setTimeout(() => window.location.href = '/auth/3-Taaza-Login.html', 2000);
                } else if (error.message.includes('400')) {
                    showToast('❌ Invalid data. Please check all fields.');
                } else if (error.message.includes('500')) {
                    showToast('🔧 Server error. Please try again.');
                } else {
                    showToast(`❌ Failed to save: ${error.message}`);
                }
            }
        };

        function editAddress(addressId) {
            const addr = addresses.find(a => a.id === addressId);
            if (!addr) return;
            openModal(addr);
        }

        async function deleteAddress(addressId) {
            if (confirm('Are you sure you want to delete this address?')) {
                try {
                    await addressAPI.deleteAddress(addressId);
                    loadAddresses();
                    showToast('Address deleted!');
                } catch (error) {
                    if (error.message.includes('401')) {
                        showToast('Session expired. Please login again.');
                        setTimeout(() => window.location.href = '/auth/3-Taaza-Login.html', 2000);
                    } else {
                        showToast('Failed to delete address');
                    }
                }
            }
        }

        async function setDefaultAddress(addressId) {
            try {
                await addressAPI.setDefaultAddress(addressId);
                loadAddresses();
                showToast('Default address updated!');
            } catch (error) {
                if (error.message.includes('401')) {
                    showToast('Session expired. Please login again.');
                    setTimeout(() => window.location.href = '/auth/3-Taaza-Login.html', 2000);
                } else {
                    showToast('Failed to update default address');
                }
            }
        }

        // Enhanced toast notification
        function showToast(msg, duration = 3000) {
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = 'fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-primary text-white px-6 py-3 rounded-lg shadow-lg z-50 hidden max-w-sm text-center';
                document.body.appendChild(toast);
            }
            
            // Clear any existing timeout
            if (toast.timeoutId) {
                clearTimeout(toast.timeoutId);
            }
            
            toast.textContent = msg;
            toast.classList.remove('hidden');
            
            toast.timeoutId = setTimeout(() => {
                toast.classList.add('hidden');
            }, duration);
        }

        // Location help function
        function showLocationHelp() {
            const helpMsg = `📍 Location Help:\n\n1. Click 🔒 icon in address bar\n2. Select "Allow" for location\n3. Try "Use My Location" again\n\nIf still not working:\n• Enable GPS/Location Services\n• Check WiFi connection\n• Use HTTPS (not HTTP)\n• Try refreshing the page`;
            
            if (confirm(helpMsg + '\n\nOpen browser location settings?')) {
                // This will prompt user to check their browser settings
                showToast('🔧 Check browser settings for location permissions');
            }
        }

        // Debug location permissions
        function checkLocationPermissions() {
            if ('permissions' in navigator) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    console.log('🔒 Geolocation permission:', result.state);
                    
                    if (result.state === 'denied') {
                        showToast('🚫 Location blocked. Check browser settings.');
                    } else if (result.state === 'prompt') {
                        showToast('📍 Location will prompt when requested.');
                    } else if (result.state === 'granted') {
                        showToast('✅ Location permission granted.');
                    }
                });
            }
        }

        // Test location on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Page loaded, checking location support...');
            
            if (navigator.geolocation) {
                console.log('✅ Geolocation API supported');
                checkLocationPermissions();
            } else {
                console.log('❌ Geolocation API not supported');
            }
            
            // Check if we're on secure context
            if (window.isSecureContext) {
                console.log('✅ Secure context (HTTPS/localhost)');
            } else {
                console.log('⚠️ Insecure context - geolocation may not work');
            }
        });

        // Initial load
        loadAddresses();
        
        async function loadAddresses() {
            try {
                addresses = await addressAPI.getAddresses();
                renderAddresses();
            } catch (error) {
                console.error('Failed to load addresses:', error);
                if (error.message.includes('401') || error.message.includes('Invalid token')) {
                    showToast('Session expired. Please login again.');
                    setTimeout(() => {
                        window.location.href = '/auth/3-Taaza-Login.html';
                    }, 2000);
                } else {
                    showToast('Failed to load addresses');
                }
            }
        }
    </script>
</body>

</html>