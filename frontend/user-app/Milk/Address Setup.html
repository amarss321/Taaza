<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taaza - Delivery Address</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#FFD700",
                        "background-light": "#FFFFFF",
                        "background-dark": "#0C2D57",
                        "zepto-blue": "#0C2D57",
                        "zepto-yellow": "#FFD700",
                        "zepto-light-bg": "#F8F4E9",
                        "zepto-manage-blue": "#4A7B9D",
                        "zepto-order-red": "#D5715C",
                        "zepto-green": "#10B981",
                        "zepto-gray": "#6B7280",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    }
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(10px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .focus-visible:focus {
            outline: 2px solid #FFD700;
            outline-offset: 2px;
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Loading spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(12, 45, 87, 0.3);
            border-radius: 50%;
            border-top-color: #0C2D57;
            animation: spin 1s ease-in-out infinite;
        }

        .section-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .dark .section-card {
            background: #1f2937;
            border-color: #374151;
        }

        .step-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .step {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .step.completed {
            background-color: #10B981;
            color: white;
        }

        .step.active {
            background-color: #0C2D57;
            color: white;
        }

        .step.pending {
            background-color: #e5e7eb;
            color: #6b7280;
        }

        .step-line {
            flex: 1;
            height: 2px;
            background-color: #e5e7eb;
            margin: 0 8px;
        }

        .step-line.completed {
            background-color: #10B981;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCTBpRefq3kQWU79YiRZOeGb7jamVPHHnw&libraries=places&callback=initMap"></script>
</head>

<body class="font-display bg-background-light dark:bg-zinc-900 text-background-dark dark:text-background-light">
    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-background-dark text-white p-4 sticky top-0 z-20 shadow-md">
            <div class="container mx-auto flex items-center justify-between">
                <button class="text-white focus-visible:focus rounded-lg p-2 hover:bg-blue-900 transition-colors"
                    onclick="goBack()" aria-label="Go back">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h1 class="text-lg font-bold">Delivery Address</h1>
                <div class="w-8"></div>
            </div>
        </header>



        <!-- Main Content -->
        <main class="flex-grow p-4 space-y-6 slide-up">
            <!-- Delivery Address Selection -->
            <div class="section-card">
                <div class="flex items-center gap-3 mb-4">
                    <span class="material-symbols-outlined text-zepto-blue dark:text-primary">location_on</span>
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Select Delivery Address</h2>
                </div>

                <!-- Loading State -->
                <div id="loading-state" class="text-center py-8">
                    <div class="spinner mx-auto mb-3"></div>
                    <p class="text-gray-600 dark:text-gray-400">Loading addresses...</p>
                </div>

                <!-- Error State -->
                <div id="error-state" class="hidden text-center py-8">
                    <span class="material-symbols-outlined text-4xl text-red-500 mb-2">error</span>
                    <p class="text-red-600 dark:text-red-400 mb-4">Failed to load addresses</p>
                    <button onclick="loadAddresses()" class="bg-zepto-blue text-white px-4 py-2 rounded-lg hover:bg-blue-800">
                        Try Again
                    </button>
                </div>

                <div id="addresses-list" class="space-y-4 hidden"></div>
                
                <div id="empty-state" class="hidden text-center py-8">
                    <span class="material-symbols-outlined text-4xl text-gray-400 mb-2">location_off</span>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">No addresses found</p>
                    <p class="text-sm text-gray-500 dark:text-gray-500">Add your first address to continue</p>
                </div>
            </div>

            <!-- Add Address Button -->
            <button onclick="openModal()" 
                class="w-full flex items-center justify-center gap-2 bg-zepto-blue text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-800 transition-colors">
                <span class="material-symbols-outlined">add</span>
                Add New Address
            </button>
        </main>

        <!-- Footer -->
        <footer
            class="p-4 bg-white/80 dark:bg-zinc-800/80 backdrop-blur-sm sticky bottom-0 border-t border-gray-200 dark:border-zinc-700">
            <button id="continue-btn" onclick="proceedToPayment()" disabled
                class="w-full bg-primary text-background-dark font-bold py-3 px-4 rounded-lg text-center hover:bg-yellow-500 transition-all duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus-visible:focus disabled:opacity-50 disabled:cursor-not-allowed">
                Continue to Summary
            </button>
        </footer>
    </div>

    <!-- Address Modal -->
    <div id="address-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden">
        <div class="bg-white dark:bg-zinc-800 rounded-xl shadow-lg w-full max-w-md mx-4 p-6 relative max-h-[90vh] overflow-y-auto">
            <button type="button" onclick="closeModal()"
                class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-zinc-700">
                <span class="material-symbols-outlined">close</span>
            </button>
            <h2 id="modal-title" class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">Add Address</h2>
            <form id="address-form" class="space-y-4">
                <input type="hidden" id="edit-index" />
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300" for="address-label">Label</label>
                    <input id="address-label" class="w-full rounded-lg border border-gray-300 dark:border-zinc-600 p-3 bg-white dark:bg-zinc-700 text-gray-800 dark:text-gray-200" type="text"
                        placeholder="e.g. Home, Work" required />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300" for="address-line">Address</label>
                    <input id="address-line" class="w-full rounded-lg border border-gray-300 dark:border-zinc-600 p-3 bg-white dark:bg-zinc-700 text-gray-800 dark:text-gray-200" type="text"
                        placeholder="Street, Apt, etc." required />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300" for="address-city">City</label>
                        <input id="address-city" class="w-full rounded-lg border border-gray-300 dark:border-zinc-600 p-3 bg-white dark:bg-zinc-700 text-gray-800 dark:text-gray-200" type="text" required />
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300" for="address-zip">ZIP Code</label>
                        <input id="address-zip" class="w-full rounded-lg border border-gray-300 dark:border-zinc-600 p-3 bg-white dark:bg-zinc-700 text-gray-800 dark:text-gray-200" type="text" required />
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300" for="address-country">Country</label>
                    <input id="address-country" class="w-full rounded-lg border border-gray-300 dark:border-zinc-600 p-3 bg-white dark:bg-zinc-700 text-gray-800 dark:text-gray-200" type="text" required />
                </div>

                <!-- Map Location Selection -->
                <div>
                    <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-300">Location on Map</label>
                    <button type="button" onclick="openMapModal()"
                        class="flex items-center gap-2 text-zepto-blue hover:text-blue-800 mb-2">
                        <span class="material-symbols-outlined">map</span>
                        <span>Select on Map</span>
                    </button>
                    <div class="text-xs text-gray-500 dark:text-gray-400">
                        <span id="coordinates-display">No location selected</span>
                    </div>
                    <input type="hidden" id="address-lat" />
                    <input type="hidden" id="address-lng" />
                </div>

                <div class="flex items-center gap-2">
                    <input id="address-default" type="checkbox" class="rounded" />
                    <label for="address-default" class="text-sm text-gray-700 dark:text-gray-300">Set as default address</label>
                </div>
                <button type="submit"
                    class="w-full bg-primary text-background-dark font-bold rounded-lg py-3 mt-2 hover:bg-yellow-500">Save
                    Address</button>
            </form>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="map-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden">
        <div class="bg-white dark:bg-zinc-800 rounded-xl shadow-lg w-full max-w-2xl mx-4 p-6 relative">
            <button type="button" onclick="closeMapModal()"
                class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-zinc-700 z-10">
                <span class="material-symbols-outlined">close</span>
            </button>
            <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">Select Location on Map</h2>
            <div class="flex gap-2 mb-4">
                <button id="locate-btn" onclick="locateUser()"
                    class="flex items-center gap-1 text-sm bg-zepto-blue/10 text-zepto-blue px-3 py-2 rounded-lg hover:bg-zepto-blue/20 transition-colors">
                    <span class="material-symbols-outlined">my_location</span>
                    Use My Location
                </button>
                <div id="locate-loading"
                    class="hidden items-center gap-1 text-sm bg-zepto-blue/10 text-zepto-blue px-3 py-2 rounded-lg">
                    <div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>
                    <span>Getting location...</span>
                </div>
            </div>
            <div id="google-map" style="height: 300px; width: 100%; border-radius: 0.5rem; overflow: hidden;"></div>
            <div class="flex justify-end gap-2 mt-4">
                <button type="button" onclick="closeMapModal()"
                    class="px-4 py-2 rounded-lg border border-gray-300 dark:border-zinc-600 hover:bg-gray-100 dark:hover:bg-zinc-700 text-gray-700 dark:text-gray-300">
                    Cancel
                </button>
                <button type="button" onclick="confirmLocation()"
                    class="px-4 py-2 rounded-lg bg-primary text-background-dark font-bold hover:bg-yellow-500">
                    Confirm Location
                </button>
            </div>
        </div>
    </div>

    <script src="../js/addresses-api.js"></script>
    <script>
        let addresses = [];
        let selectedAddressId = null;
        let addressAPI = new AddressAPI();
        
        // Google Maps variables
        let map, marker, selectedLocation = null;
        let autocomplete;

        document.addEventListener('DOMContentLoaded', function () {
            loadAddresses();
        });

        async function loadAddresses() {
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const addressesList = document.getElementById('addresses-list');
            const emptyState = document.getElementById('empty-state');
            
            // Show loading state
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            addressesList.classList.add('hidden');
            emptyState.classList.add('hidden');
            
            try {
                addresses = await addressAPI.getAddresses();
                loadingState.classList.add('hidden');
                renderAddresses();
            } catch (error) {
                console.error('Failed to load addresses:', error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                
                // Show specific error message
                const errorMsg = error.message.includes('401') ? 
                    'Session expired' : 
                    'Load failed';
                showToast(errorMsg);
            }
        }

        function renderAddresses() {
            const list = document.getElementById('addresses-list');
            const empty = document.getElementById('empty-state');
            const continueBtn = document.getElementById('continue-btn');
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            
            // Hide loading and error states
            loadingState.classList.add('hidden');
            errorState.classList.add('hidden');
            
            list.innerHTML = '';
            
            if (!addresses.length) {
                list.classList.add('hidden');
                empty.classList.remove('hidden');
                continueBtn.disabled = true;
                return;
            }
            
            list.classList.remove('hidden');
            empty.classList.add('hidden');
            
            addresses.forEach((addr) => {
                const card = document.createElement('div');
                card.className = `border-2 rounded-lg p-4 cursor-pointer transition-all ${
                    selectedAddressId === addr.id ? 'border-zepto-blue bg-blue-50 dark:bg-blue-900/20' : 'border-gray-200 dark:border-zinc-600 hover:border-gray-300'
                }`;
                card.onclick = () => selectAddress(addr.id);
                
                card.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex items-start gap-3 flex-1">
                            <input type="radio" name="address" value="${addr.id}" ${selectedAddressId === addr.id ? 'checked' : ''} 
                                class="mt-1" onchange="selectAddress(${addr.id})">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="material-symbols-outlined text-zepto-blue">${addr.label.toLowerCase() === 'work' ? 'work' : 'home'}</span>
                                    <h3 class="font-bold text-gray-800 dark:text-gray-200">${addr.label}</h3>
                                    ${addr.is_default ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-medium">Default</span>' : ''}
                                </div>
                                <p class="text-gray-700 dark:text-gray-300">${addr.address_line}</p>
                                <p class="text-gray-500 dark:text-gray-400 text-sm">${addr.city}, ${addr.zip_code}, ${addr.country}</p>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); editAddress(${addr.id})" 
                            class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-zinc-700 transition-colors">
                            <span class="material-symbols-outlined text-gray-500">edit</span>
                        </button>
                    </div>
                `;
                
                list.appendChild(card);
            });
            
            // Auto-select default address or first address
            if (!selectedAddressId) {
                const defaultAddr = addresses.find(addr => addr.is_default);
                const firstAddr = addresses[0];
                if (defaultAddr) {
                    selectAddress(defaultAddr.id);
                } else if (firstAddr) {
                    selectAddress(firstAddr.id);
                }
            }
        }

        function selectAddress(addressId) {
            selectedAddressId = addressId;
            document.getElementById('continue-btn').disabled = false;
            renderAddresses();
        }

        function editAddress(addressId) {
            const addr = addresses.find(a => a.id === addressId);
            if (!addr) return;
            openModal(addr);
        }

        function proceedToPayment() {
            if (!selectedAddressId) {
                showToast('Select address');
                return;
            }

            const selectedAddress = addresses.find(addr => addr.id === selectedAddressId);
            if (!selectedAddress) {
                showToast('Address not found');
                return;
            }

            const addressData = {
                id: selectedAddress.id,
                label: selectedAddress.label,
                address_line: selectedAddress.address_line,
                city: selectedAddress.city,
                zip_code: selectedAddress.zip_code,
                country: selectedAddress.country,
                latitude: selectedAddress.latitude,
                longitude: selectedAddress.longitude
            };

            localStorage.setItem('subscriptionAddress', JSON.stringify(addressData));

            const button = event.target;
            button.textContent = 'Processing...';
            button.disabled = true;

            setTimeout(() => {
                window.location.href = 'Final Confirmation.html';
            }, 1000);
        }

        function openModal(editAddr) {
            document.getElementById('address-modal').classList.remove('hidden');
            document.getElementById('address-form').reset();
            document.getElementById('edit-index').value = '';
            document.getElementById('coordinates-display').textContent = 'No location selected';
            document.getElementById('address-lat').value = '';
            document.getElementById('address-lng').value = '';
            selectedLocation = null;
            document.getElementById('modal-title').textContent = editAddr ? 'Edit Address' : 'Add Address';

            initAutocomplete();

            if (editAddr) {
                document.getElementById('address-label').value = editAddr.label || '';
                document.getElementById('address-line').value = editAddr.address_line || '';
                document.getElementById('address-city').value = editAddr.city || '';
                document.getElementById('address-zip').value = editAddr.zip_code || '';
                document.getElementById('address-country').value = editAddr.country || '';
                document.getElementById('address-default').checked = editAddr.is_default || false;
                document.getElementById('edit-index').value = editAddr.id;

                if (editAddr.latitude && editAddr.longitude) {
                    document.getElementById('address-lat').value = editAddr.latitude;
                    document.getElementById('address-lng').value = editAddr.longitude;
                    document.getElementById('coordinates-display').textContent =
                        `${parseFloat(editAddr.latitude).toFixed(4)}, ${parseFloat(editAddr.longitude).toFixed(4)}`;
                    selectedLocation = { lat: parseFloat(editAddr.latitude), lng: parseFloat(editAddr.longitude) };
                }
            }
        }

        function closeModal() {
            document.getElementById('address-modal').classList.add('hidden');
        }

        function openMapModal() {
            document.getElementById('map-modal').classList.remove('hidden');
            initMap();
        }

        function closeMapModal() {
            document.getElementById('map-modal').classList.add('hidden');
            if (map) {
                map = null;
                marker = null;
            }
        }

        function initAutocomplete() {
            const addressInput = document.getElementById('address-line');

            if (autocomplete) {
                google.maps.event.clearInstanceListeners(addressInput);
            }

            autocomplete = new google.maps.places.Autocomplete(addressInput, {
                types: ['address']
            });

            autocomplete.addListener('place_changed', function () {
                const place = autocomplete.getPlace();
                if (!place.geometry) return;

                let streetNumber = '', route = '', city = '', zipCode = '', country = '';

                for (const component of place.address_components) {
                    const componentType = component.types[0];
                    switch (componentType) {
                        case 'street_number': streetNumber = component.long_name; break;
                        case 'route': route = component.long_name; break;
                        case 'locality': city = component.long_name; break;
                        case 'postal_code': zipCode = component.long_name; break;
                        case 'country': country = component.long_name; break;
                    }
                }

                let addressLine = streetNumber && route ? `${streetNumber} ${route}` : route || place.formatted_address.split(',')[0];
                document.getElementById('address-line').value = addressLine;
                if (city) document.getElementById('address-city').value = city;
                if (zipCode) document.getElementById('address-zip').value = zipCode;
                if (country) document.getElementById('address-country').value = country;

                const lat = place.geometry.location.lat();
                const lng = place.geometry.location.lng();
                document.getElementById('address-lat').value = lat;
                document.getElementById('address-lng').value = lng;
                document.getElementById('coordinates-display').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                selectedLocation = { lat, lng };
            });
        }

        function initMap() {
            const defaultCenter = { lat: 12.9716, lng: 77.5946 };

            map = new google.maps.Map(document.getElementById('google-map'), {
                zoom: 13,
                center: selectedLocation || defaultCenter,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false
            });

            if (selectedLocation) {
                setMarker(selectedLocation);
            }

            map.addListener('click', function (event) {
                setMarker(event.latLng);
                reverseGeocode(event.latLng.lat(), event.latLng.lng());
            });
        }

        function setMarker(location) {
            if (marker) {
                marker.setMap(null);
            }

            marker = new google.maps.Marker({
                position: location,
                map: map,
                draggable: true
            });

            marker.addListener('dragend', function () {
                const position = marker.getPosition();
                selectedLocation = { lat: position.lat(), lng: position.lng() };
                reverseGeocode(position.lat(), position.lng());
            });

            selectedLocation = { lat: location.lat(), lng: location.lng() };
        }

        function locateUser() {
            if (!navigator.geolocation) {
                showToast('Location not supported');
                return;
            }

            document.getElementById('locate-btn').classList.add('hidden');
            document.getElementById('locate-loading').classList.remove('hidden');
            document.getElementById('locate-loading').classList.add('flex');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    if (map) {
                        map.setCenter(userLocation);
                        map.setZoom(16);
                        setMarker(userLocation);
                        reverseGeocode(userLocation.lat, userLocation.lng);
                    }
                    
                    showToast('Location found');
                    document.getElementById('locate-btn').classList.remove('hidden');
                    document.getElementById('locate-loading').classList.add('hidden');
                },
                function(error) {
                    document.getElementById('locate-btn').classList.remove('hidden');
                    document.getElementById('locate-loading').classList.add('hidden');
                    showToast('Location failed');
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function reverseGeocode(lat, lng) {
            const geocoder = new google.maps.Geocoder();
            const latLng = { lat: lat, lng: lng };

            geocoder.geocode({ 'location': latLng }, function (results, status) {
                if (status === 'OK' && results[0]) {
                    const address = results[0];
                    let streetNumber = '', route = '', city = '', zipCode = '', country = '';

                    for (const component of address.address_components) {
                        const componentType = component.types[0];
                        switch (componentType) {
                            case 'street_number': streetNumber = component.long_name; break;
                            case 'route': route = component.long_name; break;
                            case 'locality': city = component.long_name; break;
                            case 'postal_code': zipCode = component.long_name; break;
                            case 'country': country = component.long_name; break;
                        }
                    }

                    let addressLine = streetNumber && route ? `${streetNumber} ${route}` : route || address.formatted_address.split(',')[0];
                    document.getElementById('address-line').value = addressLine;
                    if (city) document.getElementById('address-city').value = city;
                    if (zipCode) document.getElementById('address-zip').value = zipCode;
                    if (country) document.getElementById('address-country').value = country;
                    if (!document.getElementById('address-label').value) {
                        document.getElementById('address-label').value = 'My Location';
                    }
                }
            });
        }

        function confirmLocation() {
            if (selectedLocation) {
                const lat = selectedLocation.lat;
                const lng = selectedLocation.lng;
                
                if (typeof lat === 'number' && typeof lng === 'number' && !isNaN(lat) && !isNaN(lng)) {
                    document.getElementById('address-lat').value = lat;
                    document.getElementById('address-lng').value = lng;
                    document.getElementById('coordinates-display').textContent = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    showToast('Location selected');
                } else {
                    showToast('Invalid location');
                    return;
                }
            } else {
                showToast('Select location first');
                return;
            }
            
            closeMapModal();
        }

        document.getElementById('address-form').onsubmit = async function (e) {
            e.preventDefault();
            
            const submitBtn = document.querySelector('#address-form button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            const label = document.getElementById('address-label').value.trim();
            const addressLine = document.getElementById('address-line').value.trim();
            const city = document.getElementById('address-city').value.trim();
            const zipCode = document.getElementById('address-zip').value.trim();
            const country = document.getElementById('address-country').value.trim();
            const lat = document.getElementById('address-lat').value;
            const lng = document.getElementById('address-lng').value;
            const isDefault = document.getElementById('address-default').checked;
            const editId = document.getElementById('edit-index').value;
            
            if (!label || !addressLine || !city || !zipCode || !country) {
                showToast('Fill all fields');
                return;
            }
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner mr-2" style="width: 16px; height: 16px; border-width: 2px;"></div>Saving...';
            
            let latitude = null, longitude = null;
            if (lat && lng) {
                latitude = parseFloat(lat);
                longitude = parseFloat(lng);
                if (isNaN(latitude) || isNaN(longitude)) {
                    latitude = null;
                    longitude = null;
                }
            }
            
            const addressData = {
                label, address_line: addressLine, city, zip_code: zipCode, country,
                latitude, longitude, is_default: isDefault
            };
            
            try {
                if (editId) {
                    await addressAPI.updateAddress(editId, addressData);
                } else {
                    await addressAPI.createAddress(addressData);
                }
                
                closeModal();
                loadAddresses();
                showToast('Address saved');
            } catch (error) {
                const errorMsg = error.message.includes('401') ? 
                    'Session expired' : 
                    error.message.includes('400') ? 
                    'Invalid data' : 
                    'Save failed';
                showToast(errorMsg);
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        };

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-zepto-green';
            toast.className = `fixed top-20 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 opacity-0 transition-opacity`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => toast.style.opacity = '1', 100);
            
            // Animate out and remove
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        function goBack() {
            window.location.href = 'new milk subscrition.html';
        }
    </script>
</body>

</html>