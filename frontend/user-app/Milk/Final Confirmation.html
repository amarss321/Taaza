<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taaza - Subscription Summary</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#FFD700",
                        "background-light": "#FFFFFF",
                        "background-dark": "#0C2D57",
                        "zepto-blue": "#0C2D57",
                        "zepto-yellow": "#FFD700",
                        "zepto-light-bg": "#F8F4E9",
                        "zepto-manage-blue": "#4A7B9D",
                        "zepto-order-red": "#D5715C",
                        "zepto-green": "#10B981",
                        "zepto-gray": "#6B7280",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    }
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .invoice-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f1f5f9;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .invoice-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #FFD700, #0C2D57);
        }

        .dark .invoice-section {
            background: #1f2937;
            border-color: #374151;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .step-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .step {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .step.completed {
            background-color: #10B981;
            color: white;
        }

        .step.active {
            background-color: #0C2D57;
            color: white;
        }

        .step-line {
            flex: 1;
            height: 2px;
            background-color: #10B981;
            margin: 0 8px;
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .dark .invoice-item {
            border-bottom-color: #374151;
        }

        .invoice-item:last-child {
            border-bottom: none;
        }

        .total-row {
            background-color: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .dark .total-row {
            background-color: #374151;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
</head>

<body class="font-display bg-background-light dark:bg-zinc-900 text-background-dark dark:text-background-light">
    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-background-dark text-white p-4 sticky top-0 z-20 shadow-md">
            <div class="container mx-auto flex items-center justify-between">
                <button class="text-white focus-visible:focus rounded-lg p-2 hover:bg-blue-900 transition-colors"
                    onclick="goBack()" aria-label="Go back">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h1 class="text-lg font-bold">Subscription Summary</h1>
                <div class="w-8"></div>
            </div>
        </header>



        <!-- Main Content -->
        <main class="flex-grow p-4 space-y-6 slide-up">
            <!-- Subscription Summary -->
            <div class="invoice-section">
                <div class="flex items-center gap-3 mb-6">
                    <span class="material-symbols-outlined text-zepto-blue dark:text-primary">receipt_long</span>
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Subscription Summary</h2>
                </div>

                <div id="summary-container" class="space-y-3 mb-6">
                    <!-- Summary items will be dynamically inserted here -->
                </div>

                <div class="border-t border-gray-200 dark:border-zinc-600 my-3"></div>
                <div class="flex justify-between items-center font-bold">
                    <p class="text-base text-gray-800 dark:text-gray-200">Estimated Monthly Price</p>
                    <p class="text-xl text-zepto-blue dark:text-primary" id="monthly-price">₹0/month</p>
                </div>
                <div class="mt-2 text-xs text-gray-500 dark:text-gray-400" id="price-breakdown">
                    No deliveries selected
                </div>
            </div>

            <!-- Delivery Address -->
            <div class="invoice-section">
                <div class="flex items-center gap-3 mb-4">
                    <span class="material-symbols-outlined text-zepto-blue dark:text-primary">location_on</span>
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Delivery Address</h2>
                </div>
                <div id="deliveryAddress" class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                    <!-- Delivery address will be populated -->
                </div>
            </div>

            <!-- Auto-Payment Information -->
            <div class="invoice-section">
                <div class="flex items-center gap-3 mb-6">
                    <span class="material-symbols-outlined text-zepto-blue dark:text-primary">payment</span>
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Auto-Payment Information</h2>
                </div>
                
                <div class="p-6 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200 dark:border-blue-800 rounded-xl">
                    <div class="space-y-6">
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">Delivery Skip Policy</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                To skip any delivery, customers must skip before 6:00 PM on the day prior to the scheduled delivery date.
                            </p>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">Auto-Payment Processing</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                Daily auto-payment will be processed at 5:30 PM from the customer's registered account for the next day delivery only.
                            </p>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">Payment Failure Policy</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                In case of payment failure, the next day delivery will be automatically cancelled without prior notice.
                            </p>
                        </div>
                    </div>
                </div>
            </div>


        </main>

        <!-- Footer -->
        <footer class="p-4 bg-white/95 dark:bg-zinc-800/95 backdrop-blur-md sticky bottom-0 border-t border-gray-200 dark:border-zinc-700 shadow-lg">
            <button onclick="confirmSubscription()" 
                class="w-full bg-gradient-to-r from-primary to-yellow-400 text-background-dark font-bold py-4 px-6 rounded-xl text-center hover:from-yellow-400 hover:to-primary transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] focus-visible:focus shadow-lg">
                Continue with Auto-Pay
            </button>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadInvoiceData();
        });

        function loadInvoiceData() {
            // Load delivery address
            const addressData = JSON.parse(localStorage.getItem('subscriptionAddress') || '{}');
            const deliveryAddressHTML = `
                <div class="flex items-start gap-3">
                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-zepto-blue/10 text-zepto-blue">
                        <span class="material-symbols-outlined">${addressData.label?.toLowerCase() === 'work' ? 'work' : 'home'}</span>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-bold text-gray-800 dark:text-gray-200">${addressData.label || 'Home'}</h3>
                            ${addressData.is_default ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-medium">Default</span>' : ''}
                        </div>
                        <p class="text-gray-700 dark:text-gray-300">${addressData.address_line || 'Address'}</p>
                        <p class="text-gray-500 dark:text-gray-400">${addressData.city || 'City'}, ${addressData.zip_code || 'ZIP'}</p>
                        <p class="text-gray-500 dark:text-gray-400">${addressData.country || 'Country'}</p>
                    </div>
                </div>
            `;
            document.getElementById('deliveryAddress').innerHTML = deliveryAddressHTML;

            // Load subscription summary
            updateSummary();
            
            // Calculate tomorrow's delivery cost
            let tomorrowCost = 0;
            const today = new Date().getDay();
            const dayKeys = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const tomorrowKey = dayKeys[(today + 1) % 7];
            
            const morningEnabled = localStorage.getItem('morningDelivery') === 'true';
            const eveningEnabled = localStorage.getItem('eveningDelivery') === 'true';
            
            if (morningEnabled) {
                const morningData = getMorningSubscriptionData();
                if (morningData.frequency === 'daily' || morningData.days.includes(tomorrowKey)) {
                    tomorrowCost += morningData.dailyPrice;
                }
            }
            
            if (eveningEnabled) {
                const eveningData = getEveningSubscriptionData();
                if (eveningData.frequency === 'daily' || eveningData.days.includes(tomorrowKey)) {
                    tomorrowCost += eveningData.dailyPrice;
                }
            }
            
            document.getElementById('tomorrowCost').textContent = `₹${tomorrowCost}`;
        }

        function getMorningSubscriptionData() {
            const milkType = localStorage.getItem('morningMilkType') || 'buffalo';
            const quantity = parseFloat(localStorage.getItem('morningQuantity') || '0.5');
            const frequency = localStorage.getItem('morningFrequency') || 'daily';
            const timeSlot = localStorage.getItem('morningTimeSlot') || '7:00-7:30';
            const days = JSON.parse(localStorage.getItem('morningDays') || '[]');
            
            const milkPrice = milkType === 'buffalo' ? 50 : 40;
            const dailyPrice = quantity * milkPrice;
            const daysPerMonth = frequency === 'daily' ? 30 : days.length * 4;
            const monthlyPrice = dailyPrice * daysPerMonth;

            return {
                milkType: milkType === 'buffalo' ? 'Buffalo Milk' : 'Cow Milk',
                quantity: `${quantity}L`,
                frequency: frequency,
                days: days,
                timeSlot: timeSlot,
                dailyPrice: dailyPrice,
                daysPerMonth: daysPerMonth,
                monthlyPrice: monthlyPrice
            };
        }

        function getEveningSubscriptionData() {
            const milkType = localStorage.getItem('eveningMilkType') || 'cow';
            const quantity = parseFloat(localStorage.getItem('eveningQuantity') || '0.5');
            const frequency = localStorage.getItem('eveningFrequency') || 'alternate';
            const timeSlot = localStorage.getItem('eveningTimeSlot') || '6:00-6:30';
            const days = JSON.parse(localStorage.getItem('eveningDays') || '[]');
            
            const milkPrice = milkType === 'buffalo' ? 50 : 40;
            const dailyPrice = quantity * milkPrice;
            const daysPerMonth = frequency === 'daily' ? 30 : days.length * 4;
            const monthlyPrice = dailyPrice * daysPerMonth;

            return {
                milkType: milkType === 'buffalo' ? 'Buffalo Milk' : 'Cow Milk',
                quantity: `${quantity}L`,
                frequency: frequency,
                days: days,
                timeSlot: timeSlot,
                dailyPrice: dailyPrice,
                daysPerMonth: daysPerMonth,
                monthlyPrice: monthlyPrice
            };
        }

        // Update the subscription summary using the same logic as new milk subscription page
        function updateSummary() {
            const summaryContainer = document.getElementById('summary-container');
            summaryContainer.innerHTML = '';

            let totalMonthlyPrice = 0;
            let priceBreakdown = '';

            // Process morning delivery if enabled
            const morningEnabled = localStorage.getItem('morningDelivery') === 'true';
            if (morningEnabled) {
                const morningSummary = getSlotSummary('morning');
                if (morningSummary) {
                    summaryContainer.appendChild(createSummaryItem(morningSummary));
                    totalMonthlyPrice += morningSummary.monthlyPrice;
                    priceBreakdown += `Morning: ₹${morningSummary.dailyPrice}/day × ${morningSummary.daysPerMonth} days = ₹${morningSummary.monthlyPrice}<br>`;
                }
            }

            // Process evening delivery if enabled
            const eveningEnabled = localStorage.getItem('eveningDelivery') === 'true';
            if (eveningEnabled) {
                const eveningSummary = getSlotSummary('evening');
                if (eveningSummary) {
                    summaryContainer.appendChild(createSummaryItem(eveningSummary));
                    totalMonthlyPrice += eveningSummary.monthlyPrice;
                    priceBreakdown += `Evening: ₹${eveningSummary.dailyPrice}/day × ${eveningSummary.daysPerMonth} days = ₹${eveningSummary.monthlyPrice}<br>`;
                }
            }

            // If no slots are selected, show empty message
            if (summaryContainer.children.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'text-center py-8 text-gray-500';
                emptyMessage.textContent = 'No subscription items found';
                summaryContainer.appendChild(emptyMessage);
            }

            // Update monthly price
            document.getElementById('monthly-price').textContent = `₹${totalMonthlyPrice}/month`;
            document.getElementById('price-breakdown').innerHTML = priceBreakdown || 'No deliveries selected';
        }

        // Get summary for a specific time slot
        function getSlotSummary(slot) {
            const milkType = localStorage.getItem(`${slot}MilkType`) || (slot === 'morning' ? 'buffalo' : 'cow');
            const quantity = parseFloat(localStorage.getItem(`${slot}Quantity`) || '0.5');
            const frequency = localStorage.getItem(`${slot}Frequency`) || (slot === 'morning' ? 'daily' : 'alternate');
            const timeSlot = localStorage.getItem(`${slot}TimeSlot`) || (slot === 'morning' ? '7:00-7:30' : '6:00-6:30');
            const days = JSON.parse(localStorage.getItem(`${slot}Days`) || '[]');
            
            const milkPrice = milkType === 'buffalo' ? 50 : 40;
            const dailyPrice = quantity * milkPrice;
            const daysPerMonth = frequency === 'daily' ? 30 : days.length * 4;
            const monthlyPrice = dailyPrice * daysPerMonth;

            let deliveryDays;
            if (frequency === 'daily') {
                deliveryDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            } else {
                const dayNames = {
                    'monday': 'Mon', 'tuesday': 'Tue', 'wednesday': 'Wed',
                    'thursday': 'Thu', 'friday': 'Fri', 'saturday': 'Sat', 'sunday': 'Sun'
                };
                deliveryDays = days.map(day => dayNames[day] || day);
            }

            return {
                slot: slot,
                milkType: milkType === 'buffalo' ? 'Buffalo Milk' : 'Cow Milk',
                quantity: `${quantity}L`,
                frequency: frequency,
                deliveryDays: deliveryDays,
                dailyPrice: dailyPrice,
                daysPerMonth: daysPerMonth,
                monthlyPrice: monthlyPrice,
                timeRange: getTimeRangeLabel(timeSlot),
                timeSlot: timeSlot
            };
        }

        // Create a summary item element (same as new milk subscription page)
        function createSummaryItem(summary) {
            const item = document.createElement('div');
            item.className = 'p-4 border-l-4 border-zepto-blue bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-zinc-700 dark:to-zinc-600 rounded-r-xl mb-4 shadow-sm hover:shadow-md transition-shadow';

            const header = document.createElement('div');
            header.className = 'flex justify-between items-center mb-2';

            const title = document.createElement('div');
            title.className = 'font-semibold text-zepto-blue dark:text-primary';
            title.textContent = `${summary.slot.charAt(0).toUpperCase() + summary.slot.slice(1)} Delivery`;

            const price = document.createElement('div');
            price.className = 'font-semibold text-zepto-green';
            price.textContent = `₹${summary.monthlyPrice}/month`;

            header.appendChild(title);
            header.appendChild(price);

            const details = document.createElement('div');
            details.className = 'text-sm text-gray-600 dark:text-gray-400 mb-2';
            details.innerHTML = `${summary.quantity} ${summary.milkType} • ${summary.frequency === 'daily' ? 'Daily' : 'Alternate days'} • ${summary.timeRange}`;

            item.appendChild(header);
            item.appendChild(details);

            if (summary.deliveryDays.length > 0) {
                const daysContainer = document.createElement('div');
                daysContainer.className = 'flex flex-wrap gap-1';

                summary.deliveryDays.forEach(day => {
                    const dayPill = document.createElement('span');
                    dayPill.className = 'bg-zepto-blue/10 text-zepto-blue dark:bg-primary/20 dark:text-primary px-3 py-1 rounded-full text-xs font-medium border border-zepto-blue/20';
                    dayPill.textContent = day;
                    daysContainer.appendChild(dayPill);
                });

                item.appendChild(daysContainer);
            }

            return item;
        }

        // Helper function to get time range label
        function getTimeRangeLabel(timeSlot) {
            const timeMap = {
                '6:00-6:30': '6:00 - 6:30 AM',
                '6:30-7:00': '6:30 - 7:00 AM', 
                '7:00-7:30': '7:00 - 7:30 AM',
                '7:30-8:00': '7:30 - 8:00 AM',
                '8:00-8:30': '8:00 - 8:30 AM',
                '8:30-9:00': '8:30 - 9:00 AM',
                '5:30-6:00': '5:30 - 6:00 PM',
                '6:00-6:30': '6:00 - 6:30 PM',
                '6:30-7:00': '6:30 - 7:00 PM',
                '7:00-7:30': '7:00 - 7:30 PM'
            };
            return timeMap[timeSlot] || timeSlot;
        }



        function confirmSubscription() {
            const button = event.target;
            button.textContent = 'Processing...';
            button.disabled = true;

            try {
                // Save subscription data
                saveSubscriptionData();
                
                // Redirect to payment page
                setTimeout(() => {
                    window.location.href = 'Payment Setup.html';
                }, 500);
            } catch (error) {
                console.error('Error:', error);
                button.textContent = 'Confirm Subscription';
                button.disabled = false;
            }
        }
        
        function saveSubscriptionData() {
            const addressData = JSON.parse(localStorage.getItem('subscriptionAddress') || '{}');
            
            const subscription = {
                id: Date.now(),
                customer: {
                    name: addressData.fullName || 'Customer',
                    phone: addressData.phoneNumber || '0000000000',
                    address: `${addressData.address || 'Address'}, ${addressData.city || 'City'}, ${addressData.state || 'State'} - ${addressData.pincode || 'PIN'}`
                },
                morningDelivery: {
                    enabled: localStorage.getItem('morningDelivery') === 'true',
                    milkType: localStorage.getItem('morningMilkType'),
                    quantity: parseFloat(localStorage.getItem('morningQuantity') || '0'),
                    timeSlot: localStorage.getItem('morningTimeSlot'),
                    frequency: localStorage.getItem('morningFrequency'),
                    days: JSON.parse(localStorage.getItem('morningDays') || '[]')
                },
                eveningDelivery: {
                    enabled: localStorage.getItem('eveningDelivery') === 'true',
                    milkType: localStorage.getItem('eveningMilkType'),
                    quantity: parseFloat(localStorage.getItem('eveningQuantity') || '0'),
                    timeSlot: localStorage.getItem('eveningTimeSlot'),
                    frequency: localStorage.getItem('eveningFrequency'),
                    days: JSON.parse(localStorage.getItem('eveningDays') || '[]')
                },
                status: 'pending_payment',
                joinedDate: new Date().toISOString().split('T')[0]
            };
            
            localStorage.setItem('pendingSubscription', JSON.stringify(subscription));
        }

        function goBack() {
            window.history.back();
        }
    </script>
</body>

</html>