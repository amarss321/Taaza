<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taaza - Subscription Summary</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#FFD700",
                        "background-light": "#FFFFFF",
                        "background-dark": "#0C2D57",
                        "zepto-blue": "#0C2D57",
                        "zepto-yellow": "#FFD700",
                        "zepto-light-bg": "#F8F4E9",
                        "zepto-manage-blue": "#4A7B9D",
                        "zepto-order-red": "#D5715C",
                        "zepto-green": "#10B981",
                        "zepto-gray": "#6B7280",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"]
                    }
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .invoice-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f1f5f9;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .invoice-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #FFD700, #0C2D57);
        }

        .dark .invoice-section {
            background: #1f2937;
            border-color: #374151;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .step-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .step {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .step.completed {
            background-color: #10B981;
            color: white;
        }

        .step.active {
            background-color: #0C2D57;
            color: white;
        }

        .step-line {
            flex: 1;
            height: 2px;
            background-color: #10B981;
            margin: 0 8px;
        }

        .invoice-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .dark .invoice-item {
            border-bottom-color: #374151;
        }

        .invoice-item:last-child {
            border-bottom: none;
        }

        .total-row {
            background-color: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .dark .total-row {
            background-color: #374151;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #0C2D57;
            border-radius: 50%;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <!-- Database API Scripts -->
    <script src="../js/data-api.js"></script>
    <script src="../js/addresses-api.js"></script>
    <script src="../js/subscription-manager.js"></script>
</head>

<body class="font-display bg-background-light dark:bg-zinc-900 text-background-dark dark:text-background-light">
    <div class="flex flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-background-dark text-white p-4 sticky top-0 z-20 shadow-md">
            <div class="container mx-auto flex items-center justify-between">
                <button class="text-white focus-visible:focus rounded-lg p-2 hover:bg-blue-900 transition-colors"
                    onclick="goBack()" aria-label="Go back">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h1 class="text-lg font-bold">Subscription Summary</h1>
                <div class="w-8"></div>
            </div>
        </header>



        <!-- Main Content -->
        <main class="flex-grow p-4 space-y-6 slide-up">
            <!-- Subscription Summary -->
            <div class="invoice-section">
                <div class="flex items-center gap-3 mb-6">
                    <span class="material-symbols-outlined text-zepto-blue dark:text-primary">receipt_long</span>
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Subscription Summary</h2>
                </div>

                <div id="summary-container" class="space-y-3 mb-6">
                    <!-- Summary items will be dynamically inserted here -->
                </div>

                <div class="border-t border-gray-200 dark:border-zinc-600 my-3"></div>
                <div class="flex justify-between items-center font-bold">
                    <p class="text-base text-gray-800 dark:text-gray-200">Estimated Monthly Price</p>
                    <p class="text-xl text-zepto-blue dark:text-primary" id="monthly-price">‚Çπ0/month</p>
                </div>
                <div class="mt-2 text-xs text-gray-500 dark:text-gray-400" id="price-breakdown">
                    No deliveries selected
                </div>
            </div>

            <!-- Delivery Address -->
            <div class="invoice-section">
                <div class="flex items-center gap-3 mb-4">
                    <span class="material-symbols-outlined text-zepto-blue dark:text-primary">location_on</span>
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Delivery Address</h2>
                </div>
                <div id="deliveryAddress" class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                    <!-- Delivery address will be populated -->
                </div>
            </div>

            <!-- Auto-Payment Information -->
            <div class="invoice-section">
                <div class="flex items-center gap-3 mb-6">
                    <span class="material-symbols-outlined text-zepto-blue dark:text-primary">payment</span>
                    <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200">Auto-Payment Information</h2>
                </div>
                
                <div class="p-6 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200 dark:border-blue-800 rounded-xl">
                    <div class="space-y-6">
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">Delivery Skip Policy</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                To skip any delivery, customers must skip before 6:00 PM on the day prior to the scheduled delivery date.
                            </p>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">Auto-Payment Processing</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                Daily auto-payment will be processed at 5:30 PM from the customer's registered account for the next day delivery only.
                            </p>
                        </div>
                        
                        <div class="mb-6">
                            <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">Payment Failure Policy</h4>
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                In case of payment failure, the next day delivery will be automatically cancelled without prior notice.
                            </p>
                        </div>
                    </div>
                </div>
            </div>


        </main>

        <!-- Footer -->
        <footer class="p-4 bg-white/95 dark:bg-zinc-800/95 backdrop-blur-md sticky bottom-0 border-t border-gray-200 dark:border-zinc-700 shadow-lg">
            <button onclick="confirmSubscription()" 
                class="w-full bg-gradient-to-r from-primary to-yellow-400 text-background-dark font-bold py-4 px-6 rounded-xl text-center hover:from-yellow-400 hover:to-primary transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] focus-visible:focus shadow-lg">
                Continue to Auto-Pay
            </button>
        </footer>
    </div>

    <script>
        // Dynamic pricing - updates from admin (same as new milk subscription)
        let milkPrices = { buffalo: 80, cow: 70 }; // Default fallback
        
        // Get milk prices from API (same function as new milk subscription)
        async function getMilkPrices() {
            try {
                const response = await fetch('/api/v1/inventory/stock');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const result = await response.json();
                const stockArray = result.stock || [];
                
                const prices = {};
                stockArray.forEach(item => {
                    if (item.type === 'buffalo' || item.type === 'cow') {
                        prices[item.type] = item.price || (item.type === 'buffalo' ? 80 : 60);
                    }
                });
                
                milkPrices = { buffalo: prices.buffalo || 80, cow: prices.cow || 60 };
                return milkPrices;
            } catch (error) {
                console.error('Failed to get prices:', error);
                return milkPrices;
            }
        }
        
        // Real-time price monitoring (same as new milk subscription)
        function startPriceMonitoring() {
            setInterval(async () => {
                const oldPrices = { ...milkPrices };
                await getMilkPrices();
                
                // Check if prices changed
                if (oldPrices.buffalo !== milkPrices.buffalo || oldPrices.cow !== milkPrices.cow) {
                    console.log('Prices updated:', milkPrices);
                    await updateSummary(); // Recalculate with new prices
                    showToast('Prices updated');
                }
            }, 5000); // Check every 5 seconds
        }
        
        // Show toast notification
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 opacity-0 transition-opacity';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.style.opacity = '1', 100);
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 2000);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìÑ Subscription Summary page loading...');
            
            // Load prices first
            await getMilkPrices();
            console.log('üí∞ Prices loaded:', milkPrices);
            
            // Start real-time price monitoring
            startPriceMonitoring();
            
            // Load invoice data
            await loadInvoiceData();
            
            console.log('‚úÖ Subscription Summary page loaded');
        });

        async function loadInvoiceData() {
            // Load delivery address from subscription database
            let addressData = {};
            try {
                const subscriptions = await window.subscriptionManager.getSubscriptions();
                const activeSubscription = subscriptions.find(sub => sub.status === 'active');
                
                console.log('üîç Active subscription:', activeSubscription);
                console.log('üìç Address data in subscription:', activeSubscription?.address_data);
                
                if (activeSubscription && activeSubscription.address_data && activeSubscription.address_data.id) {
                    addressData = activeSubscription.address_data;
                    console.log('‚úÖ Using address from subscription:', addressData);
                } else {
                    console.log('‚ö†Ô∏è No address in subscription, loading from addresses API');
                    const addressAPI = new AddressAPI();
                    const addresses = await addressAPI.getAddresses();
                    const defaultAddr = addresses.find(addr => addr.is_default) || addresses[0];
                    if (defaultAddr) {
                        addressData = defaultAddr;
                        console.log('‚úÖ Using fallback address:', addressData);
                    }
                }
            } catch (error) {
                console.error('‚ùå Failed to load address:', error);
            }
            console.log('üè† Final address data for display:', addressData);
            
            if (addressData && (addressData.address_line || addressData.label)) {
                const deliveryAddressHTML = `
                    <div class="flex items-start gap-3">
                        <div class="flex h-10 w-10 items-center justify-center rounded-full bg-zepto-blue/10 text-zepto-blue">
                            <span class="material-symbols-outlined">${addressData.label?.toLowerCase() === 'work' ? 'work' : 'home'}</span>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-gray-800 dark:text-gray-200">${addressData.label || 'Home'}</h3>
                                ${addressData.is_default ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-medium">Default</span>' : ''}
                            </div>
                            <p class="text-gray-700 dark:text-gray-300">${addressData.address_line || 'Address not available'}</p>
                            <p class="text-gray-500 dark:text-gray-400">${addressData.city || 'City'}, ${addressData.zip_code || 'ZIP'}</p>
                            <p class="text-gray-500 dark:text-gray-400">${addressData.country || 'Country'}</p>
                        </div>
                    </div>
                `;
                document.getElementById('deliveryAddress').innerHTML = deliveryAddressHTML;
            } else {
                document.getElementById('deliveryAddress').innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <span class="material-symbols-outlined mb-2">location_off</span>
                        <p>No delivery address found</p>
                    </div>
                `;
            }

            // Load subscription summary from database
            await updateSummary();
        }

        async function getSubscriptionData() {
            try {
                console.log('üîÑ Loading subscription data...');
                const subscriptionManager = new SubscriptionManager();
                const subscriptions = await subscriptionManager.getSubscriptions();
                console.log('üîç All subscriptions loaded:', subscriptions?.length || 0, 'subscriptions');
                
                // Look for active subscription first, then pending_payment, then any subscription
                const activeSubscription = subscriptions.find(sub => sub.status === 'active') || 
                                         subscriptions.find(sub => sub.status === 'pending_payment') || 
                                         subscriptions[0] || null;
                                         
                console.log('üéØ Selected subscription:', activeSubscription?.id || 'none', 'status:', activeSubscription?.status || 'none');
                
                if (activeSubscription) {
                    console.log('üìä Subscription details:');
                    console.log('  - Morning enabled:', activeSubscription.morning_enabled);
                    console.log('  - Evening enabled:', activeSubscription.evening_enabled);
                    console.log('  - Morning milk type:', activeSubscription.morning_milk_type);
                    console.log('  - Evening milk type:', activeSubscription.evening_milk_type);
                }
                
                return activeSubscription;
            } catch (error) {
                console.error('‚ùå Failed to load subscription:', error);
                return null;
            }
        }

        async function updateSummary() {
            console.log('üìä Updating subscription summary...');
            
            // Refresh prices from admin inventory (same as new milk subscription)
            await getMilkPrices();
            
            const summaryContainer = document.getElementById('summary-container');
            if (!summaryContainer) {
                console.error('‚ùå Summary container not found');
                return;
            }
            
            // Show loading state
            summaryContainer.innerHTML = '<div class="text-center py-4 text-gray-500"><div class="spinner mx-auto mb-2"></div>Loading subscription...</div>';

            let totalMonthlyPrice = 0;
            let priceBreakdown = '';

            const subscriptionData = await getSubscriptionData();
            console.log('üìã Subscription data loaded:', subscriptionData);
            
            if (!subscriptionData) {
                console.warn('‚ö†Ô∏è No subscription data found');
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'text-center py-8 text-gray-500 dark:text-gray-400';
                emptyMessage.innerHTML = `
                    <span class="material-symbols-outlined text-4xl mb-2 block">receipt_long</span>
                    <p class="font-medium">No subscription items found</p>
                    <p class="text-sm mt-1">Please create a subscription first</p>
                `;
                summaryContainer.innerHTML = '';
                summaryContainer.appendChild(emptyMessage);
                document.getElementById('monthly-price').textContent = '‚Çπ0/month';
                document.getElementById('price-breakdown').innerHTML = 'No deliveries selected';
                return;
            }
            
            // Clear loading state
            summaryContainer.innerHTML = '';

            // Process morning delivery if enabled
            if (subscriptionData.morning_enabled) {
                console.log('üåÖ Processing morning delivery');
                const morningSummary = getSlotSummaryFromDB(subscriptionData, 'morning');
                if (morningSummary) {
                    summaryContainer.appendChild(createSummaryItem(morningSummary));
                    totalMonthlyPrice += morningSummary.monthlyPrice;
                    priceBreakdown += `Morning: ‚Çπ${morningSummary.dailyPrice}/day √ó ${morningSummary.daysPerMonth} days = ‚Çπ${morningSummary.monthlyPrice}<br>`;
                    console.log('‚úÖ Morning summary added:', morningSummary);
                }
            }

            // Process evening delivery if enabled
            if (subscriptionData.evening_enabled) {
                console.log('üåô Processing evening delivery');
                const eveningSummary = getSlotSummaryFromDB(subscriptionData, 'evening');
                if (eveningSummary) {
                    summaryContainer.appendChild(createSummaryItem(eveningSummary));
                    totalMonthlyPrice += eveningSummary.monthlyPrice;
                    priceBreakdown += `Evening: ‚Çπ${eveningSummary.dailyPrice}/day √ó ${eveningSummary.daysPerMonth} days = ‚Çπ${eveningSummary.monthlyPrice}<br>`;
                    console.log('‚úÖ Evening summary added:', eveningSummary);
                }
            }
            
            // If no items were added, show empty state
            if (summaryContainer.children.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'text-center py-8 text-gray-500 dark:text-gray-400';
                emptyMessage.innerHTML = `
                    <span class="material-symbols-outlined text-4xl mb-2 block opacity-50">receipt_long</span>
                    <p class="font-medium">No active deliveries</p>
                    <p class="text-sm mt-1">Enable morning or evening delivery to see summary</p>
                `;
                summaryContainer.appendChild(emptyMessage);
            }

            // Update monthly price
            const monthlyPriceElement = document.getElementById('monthly-price');
            const priceBreakdownElement = document.getElementById('price-breakdown');
            
            if (monthlyPriceElement) {
                monthlyPriceElement.textContent = `‚Çπ${totalMonthlyPrice}/month`;
            }
            if (priceBreakdownElement) {
                priceBreakdownElement.innerHTML = priceBreakdown || 'No deliveries selected';
            }
            
            console.log('üí∞ Total monthly price:', totalMonthlyPrice);
        }

        function getSlotSummaryFromDB(subscriptionData, slot) {
            const milkType = subscriptionData[`${slot}_milk_type`] || (slot === 'morning' ? 'buffalo' : 'cow');
            const quantity = parseFloat(subscriptionData[`${slot}_quantity`] || (slot === 'morning' ? '1.0' : '0.5'));
            const frequency = subscriptionData[`${slot}_frequency`] || (slot === 'morning' ? 'daily' : 'alternate');
            const timeSlot = subscriptionData[`${slot}_time_slot`] || (slot === 'morning' ? '7:00-7:30' : '6:00-6:30');
            const days = subscriptionData[`${slot}_days`]?.days || [];
            
            // Use real-time pricing from admin API (same as new milk subscription)
            const milkPrice = milkPrices[milkType] || (milkType === 'buffalo' ? 80 : 60);
            const dailyPrice = quantity * milkPrice;
            const daysPerMonth = frequency === 'daily' ? 30 : days.length * 4;
            const monthlyPrice = dailyPrice * daysPerMonth;

            let deliveryDays;
            if (frequency === 'daily') {
                deliveryDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            } else {
                const dayNames = {
                    'monday': 'Mon', 'tuesday': 'Tue', 'wednesday': 'Wed',
                    'thursday': 'Thu', 'friday': 'Fri', 'saturday': 'Sat', 'sunday': 'Sun'
                };
                deliveryDays = days.map(day => dayNames[day] || day);
            }

            return {
                slot: slot,
                milkType: milkType === 'buffalo' ? 'Buffalo Milk' : 'Cow Milk',
                quantity: `${quantity}L`,
                frequency: frequency,
                deliveryDays: deliveryDays,
                dailyPrice: dailyPrice,
                daysPerMonth: daysPerMonth,
                monthlyPrice: monthlyPrice,
                timeRange: getTimeRangeLabel(timeSlot, slot),
                timeSlot: timeSlot
            };
        }

        // Create a summary item element (same as new milk subscription page)
        function createSummaryItem(summary) {
            const item = document.createElement('div');
            item.className = 'p-4 border-l-4 border-zepto-blue bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-zinc-700 dark:to-zinc-600 rounded-r-xl mb-4 shadow-sm hover:shadow-md transition-shadow';

            const header = document.createElement('div');
            header.className = 'flex justify-between items-center mb-2';

            const title = document.createElement('div');
            title.className = 'font-semibold text-zepto-blue dark:text-primary';
            title.textContent = `${summary.slot.charAt(0).toUpperCase() + summary.slot.slice(1)} Delivery`;

            const price = document.createElement('div');
            price.className = 'font-semibold text-zepto-green';
            price.textContent = `‚Çπ${summary.monthlyPrice}/month`;

            header.appendChild(title);
            header.appendChild(price);

            const details = document.createElement('div');
            details.className = 'text-sm text-gray-600 dark:text-gray-400 mb-2';
            details.innerHTML = `${summary.quantity} ${summary.milkType} ‚Ä¢ ${summary.frequency === 'daily' ? 'Daily' : 'Alternate days'} ‚Ä¢ ${summary.timeRange}`;

            item.appendChild(header);
            item.appendChild(details);

            if (summary.deliveryDays.length > 0) {
                const daysContainer = document.createElement('div');
                daysContainer.className = 'flex flex-wrap gap-1';

                summary.deliveryDays.forEach(day => {
                    const dayPill = document.createElement('span');
                    dayPill.className = 'bg-zepto-blue/10 text-zepto-blue dark:bg-primary/20 dark:text-primary px-3 py-1 rounded-full text-xs font-medium border border-zepto-blue/20';
                    dayPill.textContent = day;
                    daysContainer.appendChild(dayPill);
                });

                item.appendChild(daysContainer);
            }

            return item;
        }

        // Helper function to get time range label
        function getTimeRangeLabel(timeSlot, slot) {
            if (slot === 'morning') {
                const morningTimeMap = {
                    '6:00-6:30': '6:00 - 6:30 AM',
                    '6:30-7:00': '6:30 - 7:00 AM', 
                    '7:00-7:30': '7:00 - 7:30 AM',
                    '7:30-8:00': '7:30 - 8:00 AM',
                    '8:00-8:30': '8:00 - 8:30 AM',
                    '8:30-9:00': '8:30 - 9:00 AM'
                };
                return morningTimeMap[timeSlot] || timeSlot;
            } else {
                const eveningTimeMap = {
                    '5:30-6:00': '5:30 - 6:00 PM',
                    '6:00-6:30': '6:00 - 6:30 PM',
                    '6:30-7:00': '6:30 - 7:00 PM',
                    '7:00-7:30': '7:00 - 7:30 PM'
                };
                return eveningTimeMap[timeSlot] || timeSlot;
            }
        }



        async function confirmSubscription() {
            const button = event.target;
            button.textContent = 'Processing...';
            button.disabled = true;

            try {
                // Save subscription data
                await saveSubscriptionData();
                
                // Redirect to payment page
                setTimeout(() => {
                    window.location.href = 'Payment Setup.html';
                }, 500);
            } catch (error) {
                console.error('Error:', error);
                button.textContent = 'Confirm Subscription';
                button.disabled = false;
            }
        }
        
        async function saveSubscriptionData() {
            // Update subscription status to pending payment (address already saved)
            try {
                const subscriptionManager = new SubscriptionManager();
                const subscriptions = await subscriptionManager.getSubscriptions();
                const currentSub = subscriptions.find(sub => sub.status === 'active');
                
                if (currentSub) {
                    await subscriptionManager.updateSubscription(currentSub.id, {
                        status: 'pending_payment'
                    });
                    console.log('‚úÖ Subscription status updated to pending_payment');
                }
            } catch (error) {
                console.error('Failed to update subscription:', error);
            }
        }

        function goBack() {
            window.history.back();
        }
    </script>
</body>

</html>