<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Addresses - Tazza Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .sidebar-item.active {
            background: linear-gradient(135deg, #3B82F6, #1D4ED8);
            color: white;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        #map-container {
            height: 300px;
            width: 100%;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .address-card {
            transition: all 0.3s ease;
        }
        .address-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }
        .copy-btn {
            transition: all 0.2s ease;
        }
        .copy-btn:hover {
            transform: scale(1.05);
        }
        .copy-btn.copied {
            background-color: #10B981 !important;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toast-progress {
            @apply absolute bottom-0 left-0 h-1 bg-white bg-opacity-30;
            animation: toastProgress 3s linear forwards;
        }
        @keyframes toastProgress {
            from { width: 100%; }
            to { width: 0%; }
        }
    </style>
</head>
<body class="bg-gray-900">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 shadow-lg">
            <div class="p-6 border-b border-gray-700">
                <h1 class="text-2xl font-bold text-gray-100">Tazza Admin</h1>
                <p class="text-sm text-gray-400 mt-1">Address Management</p>
            </div>
            <nav class="mt-6">
                <a href="dashboard.html" class="sidebar-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 transition-colors">
                    <span class="material-symbols-outlined mr-3">dashboard</span>
                    Dashboard
                </a>
                <a href="admin.html" class="sidebar-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 transition-colors">
                    <span class="material-symbols-outlined mr-3">people</span>
                    Users
                </a>
                <a href="#" class="sidebar-item active flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 transition-colors">
                    <span class="material-symbols-outlined mr-3">location_on</span>
                    User Addresses
                </a>
                <a href="admin.html" class="sidebar-item flex items-center px-6 py-3 text-gray-300 hover:bg-gray-700 transition-colors">
                    <span class="material-symbols-outlined mr-3">history</span>
                    Activity Log
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="bg-gray-800 shadow-sm border-b border-gray-700 px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-semibold text-gray-100">User Addresses</h2>
                        <p class="text-sm text-gray-400 mt-1">View and manage user address information</p>
                    </div>
                    <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center transition-colors">
                        <span class="material-symbols-outlined mr-2">refresh</span>
                        Refresh
                    </button>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 p-6 overflow-y-auto">
                <!-- Search and Filters -->
                <div class="bg-gray-800 rounded-xl shadow-sm border border-gray-700 p-6 mb-6">
                    <div class="flex flex-wrap items-end gap-4">
                        <div class="flex-1 min-w-64">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Search Users</label>
                            <input type="text" id="user-search" placeholder="Search by user name or email..." 
                                   class="w-full border border-gray-600 bg-gray-700 text-gray-100 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="flex space-x-3">
                            <button onclick="searchUsers()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 flex items-center transition-colors">
                                <span class="material-symbols-outlined mr-2">search</span>
                                Search
                            </button>
                            <button onclick="clearSearch()" class="border border-gray-600 text-gray-300 px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-700">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-400">Total Users</p>
                                <p class="text-2xl font-bold text-gray-100" id="total-users">0</p>
                            </div>
                            <div class="p-3 bg-blue-500 bg-opacity-20 rounded-xl">
                                <span class="material-symbols-outlined text-blue-400">people</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-700">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-400">Total Addresses</p>
                                <p class="text-2xl font-bold text-gray-100" id="total-addresses">0</p>
                            </div>
                            <div class="p-3 bg-green-500 bg-opacity-20 rounded-xl">
                                <span class="material-symbols-outlined text-green-400">location_on</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-700">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-sm text-gray-400">Default Addresses</p>
                                <p class="text-2xl font-bold text-gray-100" id="default-addresses">0</p>
                            </div>
                            <div class="p-3 bg-yellow-500 bg-opacity-20 rounded-xl">
                                <span class="material-symbols-outlined text-yellow-400">star</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users with Addresses -->
                <div class="bg-gray-800 rounded-xl shadow-sm border border-gray-700 overflow-hidden">
                    <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-100">Users with Saved Addresses</h3>
                            <p class="text-sm text-gray-400 mt-1">Click on a user to view their addresses</p>
                        </div>
                        <div class="text-sm text-gray-400">
                            <span id="users-count">0</span> users found
                        </div>
                    </div>
                    
                    <div id="users-loading" class="p-8 text-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                        <p class="mt-2 text-gray-400">Loading users...</p>
                    </div>

                    <div id="users-list" class="hidden">
                        <!-- Users will be loaded here -->
                    </div>

                    <div id="no-users" class="hidden p-8 text-center">
                        <span class="material-symbols-outlined text-6xl text-gray-600 mb-4 block">location_off</span>
                        <h3 class="text-lg font-medium text-gray-300 mb-2">No Users Found</h3>
                        <p class="text-gray-400 mb-4">Try adjusting your search criteria</p>
                        <button onclick="clearSearch()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            Clear Search
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Enhanced Address Details Modal -->
    <div id="address-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-gray-700">
                <h3 class="text-xl font-semibold text-gray-100">User Addresses</h3>
                <button onclick="closeAddressModal()" class="text-gray-400 hover:text-gray-200 transition-colors p-1 rounded">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                <div id="address-details-content">
                    <!-- Address details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div id="map-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-6 border-b border-gray-700">
                <h3 class="text-xl font-semibold text-gray-100">Address Location</h3>
                <button onclick="closeMapModal()" class="text-gray-400 hover:text-gray-200 transition-colors p-1 rounded">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="p-6">
                <div id="map-container"></div>
            </div>
        </div>
    </div>

    <!-- Enhanced Toast Notification -->
    <div id="toast" class="fixed top-4 right-4 p-4 rounded-lg text-white z-50 hidden shadow-lg max-w-sm">
        <div class="flex items-start">
            <span id="toast-icon" class="material-symbols-outlined mr-3 mt-0.5"></span>
            <div class="flex-1">
                <p id="toast-message" class="text-sm"></p>
            </div>
            <button onclick="hideToast()" class="ml-4 text-white opacity-70 hover:opacity-100">
                <span class="material-symbols-outlined text-sm">close</span>
            </button>
        </div>
        <div class="toast-progress"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, marker;
        let allUsers = [];
        let currentUser = null;

        // Mock data for demonstration
        const mockUsers = [
            {
                id: 1,
                name: "John Doe",
                email: "john@example.com",
                mobile: "+1 234 567 8900",
                addresses: [
                    {
                        label: "Home",
                        line: "123 Main Street, Apt 4B",
                        city: "New York",
                        state: "NY",
                        zip: "10001",
                        country: "USA",
                        lat: 40.7128,
                        lng: -74.0060,
                        isDefault: true
                    },
                    {
                        label: "Work",
                        line: "456 Business Ave, Floor 12",
                        city: "New York", 
                        state: "NY",
                        zip: "10002",
                        country: "USA",
                        lat: 40.7589,
                        lng: -73.9851,
                        isDefault: false
                    }
                ]
            },
            {
                id: 2,
                name: "Jane Smith",
                email: "jane@example.com",
                mobile: "+1 234 567 8901",
                addresses: [
                    {
                        label: "Home",
                        line: "789 Oak Street",
                        city: "Los Angeles",
                        state: "CA",
                        zip: "90210",
                        country: "USA",
                        lat: 34.0522,
                        lng: -118.2437,
                        isDefault: true
                    }
                ]
            },
            {
                id: 3,
                name: "Mike Johnson",
                email: "mike@example.com",
                mobile: "+1 555 555 5555",
                addresses: [
                    {
                        label: "Home",
                        line: "321 Pine Road",
                        city: "Chicago",
                        state: "IL",
                        zip: "60601",
                        country: "USA",
                        lat: 41.8781,
                        lng: -87.6298,
                        isDefault: true
                    },
                    {
                        label: "Office",
                        line: "654 Corporate Blvd, Suite 500",
                        city: "Chicago",
                        state: "IL",
                        zip: "60602", 
                        country: "USA",
                        lat: 41.8825,
                        lng: -87.6324,
                        isDefault: false
                    },
                    {
                        label: "Warehouse",
                        line: "987 Industrial Way",
                        city: "Chicago",
                        state: "IL",
                        zip: "60603",
                        country: "USA", 
                        lat: 41.8500,
                        lng: -87.6500,
                        isDefault: false
                    }
                ]
            }
        ];

        // Load users with addresses
        function loadUsers() {
            document.getElementById('users-loading').classList.remove('hidden');
            document.getElementById('users-list').classList.add('hidden');
            document.getElementById('no-users').classList.add('hidden');

            // Simulate API call delay
            setTimeout(() => {
                allUsers = mockUsers;
                displayUsers(allUsers);
                updateStats(allUsers);
                document.getElementById('users-loading').classList.add('hidden');
            }, 1000);
        }

        function updateStats(users) {
            const totalUsers = users.length;
            const totalAddresses = users.reduce((sum, user) => sum + user.addresses.length, 0);
            const defaultAddresses = users.reduce((sum, user) => 
                sum + user.addresses.filter(addr => addr.isDefault).length, 0);
            
            document.getElementById('total-users').textContent = totalUsers;
            document.getElementById('total-addresses').textContent = totalAddresses;
            document.getElementById('default-addresses').textContent = defaultAddresses;
            document.getElementById('users-count').textContent = totalUsers;
        }

        function displayUsers(users) {
            const container = document.getElementById('users-list');
            
            if (!users.length) {
                document.getElementById('no-users').classList.remove('hidden');
                return;
            }

            container.innerHTML = users.map(user => `
                <div class="border-b border-gray-700 last:border-b-0">
                    <div class="p-6 hover:bg-gray-750 transition-colors cursor-pointer" onclick="viewUserAddresses(${user.id})">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-medium text-lg shadow-lg">
                                    ${user.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h4 class="text-lg font-medium text-gray-100">${user.name}</h4>
                                    <p class="text-sm text-gray-400">${user.email}</p>
                                    <p class="text-sm text-gray-400">${user.mobile}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <div class="text-right">
                                    <p class="text-sm font-medium text-gray-200">${user.addresses.length} Address${user.addresses.length !== 1 ? 'es' : ''}</p>
                                    <p class="text-xs text-gray-400">${user.addresses.filter(a => a.isDefault).length} Default</p>
                                </div>
                                <span class="material-symbols-outlined text-gray-400">chevron_right</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.classList.remove('hidden');
        }

        function searchUsers() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                displayUsers(allUsers);
                updateStats(allUsers);
                return;
            }

            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(searchTerm) ||
                user.email.toLowerCase().includes(searchTerm)
            );
            
            displayUsers(filteredUsers);
            updateStats(filteredUsers);
        }

        function clearSearch() {
            document.getElementById('user-search').value = '';
            displayUsers(allUsers);
            updateStats(allUsers);
        }

        function viewUserAddresses(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) return;

            currentUser = user;
            const content = document.getElementById('address-details-content');
            
            content.innerHTML = `
                <div class="mb-6 fade-in">
                    <div class="flex items-center space-x-4 mb-4 p-4 bg-gray-750 rounded-xl">
                        <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-medium text-xl shadow-lg">
                            ${user.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <h4 class="text-xl font-medium text-gray-100">${user.name}</h4>
                            <p class="text-gray-400">${user.email}</p>
                            <p class="text-gray-400">${user.mobile}</p>
                        </div>
                    </div>
                </div>

                <div class="mb-4 flex justify-between items-center">
                    <h4 class="text-lg font-medium text-gray-100">${user.addresses.length} Saved Address${user.addresses.length !== 1 ? 'es' : ''}</h4>
                    <button onclick="copyAllAddresses()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center transition-colors">
                        <span class="material-symbols-outlined mr-2">content_copy</span>
                        Copy All
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${user.addresses.map((address, index) => `
                        <div class="address-card bg-gray-750 rounded-xl p-6 ${address.isDefault ? 'border-2 border-yellow-400' : 'border border-gray-600'}">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 ${address.label.toLowerCase() === 'work' ? 'bg-green-500' : 'bg-blue-500'} rounded-full flex items-center justify-center text-white shadow-md">
                                        <span class="material-symbols-outlined">${address.label.toLowerCase() === 'work' ? 'work' : 'home'}</span>
                                    </div>
                                    <div>
                                        <h5 class="font-medium text-gray-100">${address.label}</h5>
                                        ${address.isDefault ? '<span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-full font-medium">DEFAULT</span>' : ''}
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    ${address.lat && address.lng ? `
                                        <button onclick="showAddressOnMap(${address.lat}, ${address.lng}, '${address.label}')" 
                                                class="text-blue-400 hover:text-blue-300 p-1 rounded transition-colors"
                                                title="View on Map">
                                            <span class="material-symbols-outlined">map</span>
                                        </button>
                                    ` : ''}
                                    <button onclick="copyAddress(${index})" 
                                            class="copy-btn text-gray-400 hover:text-gray-200 p-1 rounded transition-colors"
                                            title="Copy Address">
                                        <span class="material-symbols-outlined">content_copy</span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="space-y-3 text-gray-200">
                                <div class="flex items-start">
                                    <span class="material-symbols-outlined text-gray-400 mr-2 mt-0.5 text-sm">location_on</span>
                                    <p class="font-medium">${address.line}</p>
                                </div>
                                <div class="flex items-center">
                                    <span class="material-symbols-outlined text-gray-400 mr-2 text-sm">apartment</span>
                                    <p>${address.city}, ${address.state} ${address.zip}</p>
                                </div>
                                <div class="flex items-center">
                                    <span class="material-symbols-outlined text-gray-400 mr-2 text-sm">flag</span>
                                    <p>${address.country}</p>
                                </div>
                                ${address.lat && address.lng ? `
                                    <div class="flex items-center text-xs text-gray-400 font-mono bg-gray-800 p-2 rounded">
                                        <span class="material-symbols-outlined mr-1 text-xs">gps_fixed</span>
                                        ${parseFloat(address.lat).toFixed(6)}, ${parseFloat(address.lng).toFixed(6)}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('address-modal').classList.remove('hidden');
            document.getElementById('address-modal').classList.add('flex');
        }

        function copyAddress(index) {
            if (!currentUser || !currentUser.addresses[index]) return;
            
            const address = currentUser.addresses[index];
            const fullAddress = `${address.line}, ${address.city}, ${address.state} ${address.zip}, ${address.country}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(fullAddress).then(() => {
                // Show success feedback
                const copyBtn = document.querySelectorAll('.copy-btn')[index];
                copyBtn.classList.add('copied');
                copyBtn.innerHTML = '<span class="material-symbols-outlined">check</span>';
                
                showToast(`"${address.label}" address copied to clipboard`, 'success');
                
                // Reset button after 2 seconds
                setTimeout(() => {
                    copyBtn.classList.remove('copied');
                    copyBtn.innerHTML = '<span class="material-symbols-outlined">content_copy</span>';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy address', 'error');
            });
        }

        function copyAllAddresses() {
            if (!currentUser) return;
            
            let allAddressesText = `Addresses for ${currentUser.name}\n\n`;
            
            currentUser.addresses.forEach(address => {
                const fullAddress = `${address.line}, ${address.city}, ${address.state} ${address.zip}, ${address.country}`;
                allAddressesText += `${address.label}${address.isDefault ? ' (Default)' : ''}:\n${fullAddress}\n\n`;
            });
            
            // Copy to clipboard
            navigator.clipboard.writeText(allAddressesText).then(() => {
                showToast('All addresses copied to clipboard', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showToast('Failed to copy addresses', 'error');
            });
        }

        function closeAddressModal() {
            document.getElementById('address-modal').classList.add('hidden');
            document.getElementById('address-modal').classList.remove('flex');
            currentUser = null;
        }

        function showAddressOnMap(lat, lng, label) {
            document.getElementById('map-modal').classList.remove('hidden');
            document.getElementById('map-modal').classList.add('flex');
            
            // Initialize map
            setTimeout(() => {
                if (map) {
                    map.remove();
                }
                
                map = L.map('map-container').setView([lat, lng], 15);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                marker = L.marker([lat, lng]).addTo(map)
                    .bindPopup(`<b>${label}</b><br>Lat: ${lat}<br>Lng: ${lng}`)
                    .openPopup();
            }, 100);
        }

        function closeMapModal() {
            document.getElementById('map-modal').classList.add('hidden');
            document.getElementById('map-modal').classList.remove('flex');
            
            if (map) {
                map.remove();
                map = null;
                marker = null;
            }
        }

        function refreshData() {
            loadUsers();
            showToast('Data refreshed successfully', 'success');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            
            const colors = {
                'success': 'bg-green-600',
                'error': 'bg-red-600',
                'warning': 'bg-yellow-600',
                'info': 'bg-blue-600'
            };
            
            const icons = {
                'success': 'check_circle',
                'error': 'error',
                'warning': 'warning',
                'info': 'info'
            };
            
            toast.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 shadow-lg max-w-sm ${colors[type]} fade-in`;
            toastMessage.textContent = message;
            toastIcon.textContent = icons[type];
            toast.classList.remove('hidden');
            
            // Reset and restart progress bar animation
            const progress = toast.querySelector('.toast-progress');
            progress.style.animation = 'none';
            setTimeout(() => {
                progress.style.animation = 'toastProgress 3s linear forwards';
            }, 10);
            
            setTimeout(() => {
                hideToast();
            }, 3000);
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            toast.classList.add('hidden');
        }

        // Search on Enter key
        document.getElementById('user-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchUsers();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
        });
    </script>
</body>
</html>